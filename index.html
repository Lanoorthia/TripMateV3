<!doctype html>
<html lang="th" class="">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TripMate ‚Äî Feed with Dark/Light, TH/EN, Media & Hashtags</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    /* Dark overrides for common utility classes */
    
    
    
    
    
    
    
    

    /* Feed cards */
    .masonry{ column-count: 1; column-gap: 1rem; }
    @media (min-width: 768px){ .masonry{ column-count: 2; } }
    @media (min-width: 1024px){ .masonry{ column-count: 3; } }
    .masonry-item{ break-inside: avoid; }

    .chip{ display:inline-flex; align-items:center; gap:.35rem; font-size:.875rem; padding:.25rem .6rem;
           border-radius:999px; border:1px solid rgba(148,163,184,.35); background:rgba(148,163,184,.12); }
    .chip:hover{ filter:brightness(1.05); }
    .ratio-4-5{ position:relative; padding-bottom:125%; }
    .ratio-4-5 > *{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:.75rem; }
    .btn{ border:1px solid #2563eb; color:#2563eb; padding:.5rem .9rem; border-radius:999px; }
    .btn:hover{ background:#2563eb; color:#fff; }
    .btn-solid{ background:#2563eb; color:#fff; border:0; }
    .btn-solid:hover{ filter:brightness(1.05); }
    .focus-ring:focus-visible{ outline:2px solid #2563eb; outline-offset:2px; }

    .no-scrollbar{ scrollbar-width: none; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Top Bar -->
  <header class="sticky top-0 z-40 border-b bg-white/80 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-2 flex items-center gap-3">
      <div class="flex items-center gap-2 flex-1">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-500 text-white grid place-items-center font-bold">T</div>
        <div class="font-extrabold tracking-tight">TripMate</div>
        <div class="hidden sm:flex items-center gap-2 ml-3 flex-1 max-w-md rounded-full px-3 py-1.5 border bg-white/60">
          <span>üîé</span>
          <input id="topSearch" class="bg-transparent outline-none text-sm w-full" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà ¬∑ ‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ¬∑ ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß" />
        </div>
      </div>
      <div class="flex items-center gap-2">
        
        <button id="langToggle" class="chip" aria-label="Toggle language">TH</button>
        <a href="https://forms.gle/JuJ2WWLeiRyTQSNU6" target="_blank" rel="noopener"
           class="border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white transition rounded-full px-4 py-1.5 text-sm">
           ‡∏™‡πà‡∏á‡∏ü‡∏µ‡∏î‡πÅ‡∏ö‡πá‡∏Å
        </a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto px-4 py-4 pb-28 space-y-6">
    <section id="page-discover" class="space-y-4">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <div class="font-semibold" id="feedTitle" data-i18n="feed">‡∏ü‡∏µ‡∏î</div>
        <div class="flex items-center gap-2">
          <button id="openCreatePost" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-4 py-2 text-sm">+ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
          <button id="toggleView" class="border rounded-full px-3 py-2 text-sm">‡πÇ‡∏´‡∏°‡∏î: ‡∏†‡∏≤‡∏û‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á</button>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <div class="hidden md:flex items-center gap-2">
          <input id="searchTag" class="chip focus-ring" placeholder="#‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏Å" />
          <button id="goTag" class="chip">üîé</button>
        </div>
      </div>

      <div id="promoBanners" class="flex gap-3 overflow-x-auto no-scrollbar"></div>
      <div id="topTags" class="flex gap-2 overflow-x-auto no-scrollbar"></div>

      <section>
        <div class="text-sm font-semibold mb-2" data-i18n="trending"># ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡πÅ‡∏£‡∏á</div>
        <div id="trendingBar" class="flex flex-wrap gap-2"></div>
      </section>

      <section id="discoverMasonry" class="masonry"></section>
      <section id="discoverTiles" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></section>
    </section>

    <section id="page-search" class="hidden space-y-3">
      <div class="flex items-center gap-2">
        <div class="relative flex-1">
          <input id="searchInput" class="w-full border rounded-xl pl-9 pr-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£...">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">üîé</span>
        </div>
        <button id="applySearchBtn" class="border rounded-full px-3 py-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤üîé</button>
      </div>
      <div id="categoryChips" class="flex gap-2 overflow-x-auto no-scrollbar py-1"></div>
      <div id="provinceChips" class="flex gap-2 overflow-x-auto no-scrollbar py-1"></div>
      <div class="flex items-center gap-3 text-sm text-gray-600">
        <span>üß≠ ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</span> <span id="distVal">80</span> ‡∏Å‡∏°.
      </div>
      <input id="distSlider" type="range" min="5" max="200" step="5" value="80" class="w-full accent-blue-600" />
      <div id="locInfo" class="text-xs text-gray-500"></div>
      <div id="searchResults" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>

    <section id="page-groups" class="hidden space-y-4">
      <div id="groupContainer"></div>
    </section>

    <section id="page-rewards" class="hidden space-y-4">
      <div class="bg-white border rounded-2xl p-4 flex items-center justify-between">
        <div>
          <div class="text-lg font-semibold">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
          <div id="pointsEl" class="text-2xl font-bold text-blue-600">0 pts</div>
          <div id="badgesEl" class="mt-1 text-sm text-gray-500">‡πÅ‡∏ö‡∏î‡∏à‡πå: -</div>
        </div>
        <div class="text-4xl">üèÖ</div>
      </div>
      <div class="font-semibold">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
      <div id="rewardsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
      <div class="font-semibold">‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡πÉ‡∏´‡∏°‡πà)</div>
      <div id="cosmeticsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>

    <section id="page-profile" class="hidden space-y-4">
      <div id="profileCard" class="relative bg-white border rounded-2xl overflow-hidden">
        <div id="profileTheme" class="h-24 theme-basic"></div>
        <div class="p-4 pt-0">
          <div class="relative -mt-8 flex items-center gap-3">
            <div id="avatarWrap" class="w-16 h-16 rounded-full bg-white grid place-items-center overflow-hidden frame-none">
              <img id="avatarImg" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=256&auto=format&fit=crop" class="w-full h-full object-cover"/>
            </div>
            <div class="min-w-0">
              <div class="text-xl font-semibold">
                <span id="userNameEl">‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà</span>
                <span id="userHandleEl" class="text-sm text-gray-500">@tammy</span>
              </div>
              <div id="userMetaEl" class="text-sm text-gray-500">‡∏£‡∏∞‡∏î‡∏±‡∏ö: Explorer ¬∑ ‡πÅ‡∏ï‡πâ‡∏°: 0 ¬∑ ‡πÅ‡∏ö‡∏î‡∏à‡πå: -</div>
            </div>
          </div>
          <div id="profileStickers" class="relative h-0"></div>
          <div class="mt-3">
            <div class="font-semibold mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
            <div id="myReviews" class="space-y-2"></div>
          </div>
        </div>
      </div>
      <div class="bg-white border rounded-2xl p-4 space-y-3">
        <div class="font-semibold">‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á</div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="ownedCosmetics"></div>
      </div>
    </section>
  </main>

  <dialog id="createModal" class="rounded-2xl p-0 w-[90vw] max-w-xl">
    <form method="dialog" class="p-4 border-b border-gray-200 flex items-center justify-between">
      <div class="font-semibold" data-i18n="create">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</div>
      <button class="chip">‚úï</button>
    </form>
    <div class="p-4 space-y-3">
      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà -->
      <div class="flex items-end gap-2">
        <div class="flex-1">
          <label class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
          <select id="placeSelect" class="w-full border border-gray-200 rounded-xl p-2 focus-ring"></select>
        </div>
        <button id="addPlaceBtn" type="button" class="chip">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</button>
      </div>
      <label class="text-sm" data-i18n="caption">‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢</label>
      <textarea id="cap" rows="5" class="w-full border border-gray-200 rounded-xl p-3 focus-ring"
        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå #‡πÅ‡∏ó‡πá‡∏Å ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô #‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ #family)"></textarea>

      <div>
        <label class="text-sm" data-i18n="media">‡∏™‡∏∑‡πà‡∏≠ (‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)</label>
        <input id="file" type="file" accept="image/*,video/mp4,video/webm"
               class="mt-1 w-full border border-gray-200 rounded-lg p-2 focus-ring" />
        <div id="preview" class="mt-2"></div>
      </div>

      <div class="flex items-center justify-end gap-2 pt-2">
        <button class="chip" formmethod="dialog" data-i18n="cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="submitPost" class="btn-solid" data-i18n="post">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
      </div>
    </div>
  </dialog>

  <!-- Add Place Modal -->
  <dialog id="placeModal" class="rounded-2xl p-0 w-[90vw] max-w-lg">
    <form method="dialog" class="p-4 border-b border-gray-200 flex items-center justify-between">
      <div class="font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</div>
      <button class="chip">‚úï</button>
    </form>
    <div class="p-4 space-y-3">
      <div>
        <label class="text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="plName" class="w-full border border-gray-200 rounded-xl p-2 focus-ring" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏£‡∏µ‡∏°‡πÄ‡∏ß‡∏¥‡∏•‡∏î‡πå"/>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="text-sm">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
          <input id="plProvince" class="w-full border border-gray-200 rounded-xl p-2 focus-ring" placeholder="‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ"/>
        </div>
        <div>
          <label class="text-sm">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
          <input id="plCategory" class="w-full border border-gray-200 rounded-xl p-2 focus-ring" placeholder="‡∏™‡∏ß‡∏ô‡∏™‡∏ô‡∏∏‡∏Å/‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà/‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥"/>
        </div>
      </div>
      <div>
        <label class="text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</label>
        <input id="plHours" class="w-full border border-gray-200 rounded-xl p-2 focus-ring" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10:00‚Äì18:00"/>
      </div>
      <div>
        <label class="text-sm">‡πÅ‡∏ó‡πá‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á, ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö #)</label>
        <input id="plTags" class="w-full border border-gray-200 rounded-xl p-2 focus-ring" placeholder="#‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß #‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ"/>
      </div>
      <div>
        <label class="text-sm">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</label>
        <input id="plPhoto" class="w-full border border-gray-200 rounded-xl p-2 focus-ring" placeholder="https://..."/>
      </div>
      <div class="flex items-center justify-end gap-2 pt-2">
        <button class="chip" formmethod="dialog">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="savePlaceBtn" type="button" class="btn-solid">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</button>
      </div>
    </div>
  </dialog>

  <button id="fabCreate" class="fixed bottom-20 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg px-4 py-3 text-sm">
    + ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
  </button>

  <nav class="fixed bottom-0 inset-x-0 bg-white border-t z-40">
    <div class="max-w-5xl mx-auto grid grid-cols-5 text-sm">
      <button data-tab="discover" class="py-3 flex flex-col items-center text-blue-600">üè†<span class="text-xs">‡∏ü‡∏µ‡∏î</span></button>
      <button data-tab="search" class="py-3 flex flex-col items-center text-gray-600">üîé<span class="text-xs">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span></button>
      <button data-tab="groups" class="py-3 flex flex-col items-center text-gray-600">üë•<span class="text-xs">‡∏Å‡∏•‡∏∏‡πà‡∏°</span></button>
      <button data-tab="rewards" class="py-3 flex flex-col items-center text-gray-600">‚≠ê<span class="text-xs">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span></button>
      <button data-tab="profile" class="py-3 flex flex-col items-center text-gray-600">üë§<span class="text-xs">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></button>
    </div>
  </nav>

  <div id="detailModal" class="hidden fixed inset-0 bg-black/50 z-50 p-4">
    <div class="bg-white w-full max-w-2xl mx-auto mt-[10vh] rounded-2xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        <button id="closeDetail" class="px-3 py-1.5 rounded-xl hover:bg-gray-100">‚úï</button>
      </div>
      <div id="detailContent" class="space-y-4"></div>
    </div>
  </div>

  <script>
    // --- safety helpers (minimal fixes) ---
    function qAll(rootSelectorOrEl, sel){
      const root = typeof rootSelectorOrEl === 'string' ? document.querySelector(rootSelectorOrEl) : rootSelectorOrEl;
      if(!root) return [];
      return Array.from(root.querySelectorAll(sel));
    }
    function safeEl(sel){ return typeof sel==='string'? document.querySelector(sel): sel; }

    /* ============== Language & Theme ============== */
    const I18N = {
      th: { create:"+ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß", feed:"‡∏ü‡∏µ‡∏î", trending:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡πÅ‡∏£‡∏á", caption:"‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢", media:"‡∏™‡∏∑‡πà‡∏≠ (‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)", cancel:"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", post:"‡πÇ‡∏û‡∏™‡∏ï‡πå", searchPH:"#‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏Å" },
      en: { create:"+ Create Post", feed:"Feed", trending:"Trending now", caption:"Caption", media:"Media (image/video)", cancel:"Cancel", post:"Post", searchPH:"#Search tag" }
    };
    const getLang = () => localStorage.getItem("lang") || "th";
    function applyI18N(){
      const L = I18N[getLang()];
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        if (L[key]) el.textContent = L[key];
      });
      document.getElementById("langToggle").textContent = getLang().toUpperCase();
      document.getElementById("searchTag").placeholder = L.searchPH;
    }
    function initLang(){
      if(!localStorage.getItem("lang")) localStorage.setItem("lang","th");
      applyI18N();
      document.getElementById("langToggle").onclick = ()=>{
        const next = getLang()==="th" ? "en" : "th";
        localStorage.setItem("lang", next);
        applyI18N(); renderDiscover();
      };
    }
    
    /* ============== Helpers ============== */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const setHidden = (el, hidden) => { if(el) el.classList.toggle("hidden", hidden); };

    /* ============== Hashtags ============== */
    const hashtagRegex = /#([A-Za-z0-9_\u0E00-\u0E7F]{2,50})/g;
    function normalizeTag(raw){
      const clean = raw.normalize("NFC").trim().replace(/^#/,"");
      const lower = clean.toLowerCase();
      const kept = Array.from(lower).filter(ch=>/[a-z0-9_\u0E00-\u0E7F]/i.test(ch)).join("");
      return kept;
    }
    const slugifyTag = normalizeTag;
    function extractHashtags(text){
      const s = new Set();
      (text||"").replace(hashtagRegex, (_m,_w,tag)=>{
        const slug = slugifyTag(tag);
        if(slug.length>=2 && slug.length<=50) s.add(slug);
      });
      return [...s];
    }
    function linkifyHashtags(text){
      return (text||"").replace(hashtagRegex, (_m, ws, tag) => {
        const slug = slugifyTag(tag);
        return `${ws}<span class="chip">#${tag}</span>`;
      });
    }

    /* ============== Feed Data ============== */
    const POSTS = [
      {
        id: "p1",
        user: "Pim",
        avatar: "https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?q=80&w=256&auto=format&fit=crop",
        text: "‡∏ß‡∏±‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡πÜ ‡∏ó‡∏µ‡πà #‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ ‡πÅ‡∏ß‡∏∞ #‡∏ï‡∏•‡∏≤‡∏î‡∏ß‡∏±‡∏î‡∏®‡∏≤‡∏•‡πÄ‡∏à‡πâ‡∏≤ ‡∏≠‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏Å ü•∞ #local_food #photo_spot",
        media: { type:"image", src:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop" },
        ratio: "4/5", likes: 12
      },
      {
        id: "p2",
        user: "Non",
        avatar: "https://images.unsplash.com/photo-1552374196-c4e7ffc6e126?q=80&w=256&auto=format&fit=crop",
        text: "‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏∏‡∏î‡∏°‡∏±‡∏ô‡∏ó‡∏µ‡πà #dreamworld #theme_park #family",
        media: { type:"video", src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
        ratio: "4/5", likes: 7
      }
    ];

    /* ===== Places (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà) ===== */
    const PLACES = [
      { id:"pl_dreamworld", name:"‡∏î‡∏£‡∏µ‡∏°‡πÄ‡∏ß‡∏¥‡∏•‡∏î‡πå", province:"‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", category:"‡∏™‡∏ß‡∏ô‡∏™‡∏ô‡∏∏‡∏Å", openingHours:"10:00‚Äì17:00",
        tags:["‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß","theme_park","‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô"], photo:"https://images.unsplash.com/photo-1506806732259-39c2d0268443?q=80&w=1200&auto=format&fit=crop" },
      { id:"pl_talad_wat_sanjao", name:"‡∏ï‡∏•‡∏≤‡∏î‡∏ß‡∏±‡∏î‡∏®‡∏≤‡∏•‡πÄ‡∏à‡πâ‡∏≤", province:"‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", category:"‡∏ï‡∏•‡∏≤‡∏î/‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô", openingHours:"10:00‚Äì19:00",
        tags:["local_food","street_food","‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ"], photo:"https://images.unsplash.com/photo-1498654896293-37aacf113fd9?q=80&w=1200&auto=format&fit=crop" },
      { id:"pl_river_spot", name:"‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤ (‡∏£‡∏±‡∏á‡∏™‡∏¥‡∏ï-‡∏õ‡∏ó‡∏∏‡∏°)", province:"‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥/‡∏ß‡∏¥‡∏ß", openingHours:"06:00‚Äì19:00",
        tags:["‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢","‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô","photo_spot"], photo:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop" }
    ];

    function populatePlaceSelect(){
      const sel = document.getElementById("placeSelect");
      if(!sel) return;
      sel.innerHTML = PLACES.map(p=>`<option value="${p.id}">${p.name} ¬∑ ${p.province}</option>`).join("");
    }

    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
    document.getElementById("addPlaceBtn").onclick = () => document.getElementById("placeModal").showModal();

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
    document.getElementById("savePlaceBtn").onclick = () => {
      const name = document.getElementById("plName").value.trim();
      const province = document.getElementById("plProvince").value.trim() || "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ";
      const category = document.getElementById("plCategory").value.trim() || "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà";
      const openingHours = document.getElementById("plHours").value.trim() || "-";
      const tagsRaw = document.getElementById("plTags").value.trim();
      const photo = document.getElementById("plPhoto").value.trim();

      if(!name){ alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞"); return; }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ó‡πá‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö #)
      const tagList = [...new Set([
        ...extractHashtags(tagsRaw),
        ...tagsRaw.split(/\s+/).map(t=>slugifyTag(t)).filter(Boolean)
      ])];

      const pl = {
        id: "pl_"+Date.now(),
        name, province, category, openingHours, tags: tagList,
        photo: photo || "https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1200&auto=format&fit=crop"
      };
      PLACES.unshift(pl);
      populatePlaceSelect();
      document.getElementById("placeModal").close();

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï tag-index ‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ô‡∏±‡∏ö‡∏£‡∏ß‡∏°)
      const idx = loadTagIndex(); const now = Date.now();
      for(const slug of tagList){
        const cur = idx.tags[slug] || { name: slug, count:0, postIds:[], placeIds:[], updatedAt:now };
        cur.count += 1;
        cur.placeIds = cur.placeIds || [];
        if(!cur.placeIds.includes(pl.id)) cur.placeIds.push(pl.id);
        cur.updatedAt = now;
        idx.tags[slug] = cur;
      }
      saveTagIndex(idx);
      renderTrending();
      alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    };
    const TAG_INDEX_KEY = "tripmate_tags";
    function loadTagIndex(){ try{ return JSON.parse(localStorage.getItem(TAG_INDEX_KEY)||'{"tags":{}}'); }catch{return {tags:{}}} }
    function saveTagIndex(x){ localStorage.setItem(TAG_INDEX_KEY, JSON.stringify(x)); }
    function updateTagIndexFromPost(post){
      const idx = loadTagIndex(); const now = Date.now();
      const list = extractHashtags(post.text).map(slug=>({slug, name: slug}));
      for(const t of list){
        const cur = idx.tags[t.slug] || { name:t.name, count:0, postIds:[], placeIds:[], updatedAt:now };
        cur.name ||= t.name; cur.count += 1;
        if(!cur.postIds.includes(post.id)) cur.postIds.push(post.id);
        cur.updatedAt = now;
        idx.tags[t.slug] = cur;
      }
      saveTagIndex(idx);
    }
    POSTS.forEach(updateTagIndexFromPost);

    function postCard(p){
      const pb = "ratio-4-5";
      let media = "";
      if(p.media?.type==="video"){
        media = `<video src="${p.media.src}" controls playsinline class="w-full h-full rounded-xl"></video>`;
      }else{
        media = `<img src="${p.media?.src}" alt="">`;
      }
      return `
        <article class="masonry-item bg-white border border-gray-200 rounded-2xl overflow-hidden mb-4">
          <div class="p-3 flex items-center gap-3">
            <img src="${p.avatar}" class="w-9 h-9 rounded-full object-cover" alt="${p.user}"/>
            <div class="font-medium text-gray-900">${p.user}</div>
            <div class="ml-auto text-sm text-gray-500">‚ù§Ô∏è ${p.likes}</div>
          </div>
          <div class="px-3 pb-3">
            <div class="${pb}">${media}</div>
          </div>
          <div class="px-3 pb-4 -mt-2">
            ${p.place ? `<div class="mb-2 flex flex-wrap gap-2">
                <span class="chip">üìç ${p.place.name}</span>
                <span class="chip">${p.place.province}</span>
                <span class="chip">${p.place.category}</span>
              </div>` : ``}
            <div class="text-sm text-gray-700">${linkifyHashtags(p.text)}</div>
            <div class="mt-2 flex flex-wrap gap-2">
              
            </div>
          </div>
        </article>
      `;
    }
    function renderFeed(){
      const container = document.getElementById("discoverMasonry");
      if(!container) return;
      container.innerHTML = POSTS.length
        ? POSTS.map(postCard).join("")
        : `<div class="text-sm text-gray-500">${getLang()==="th"?"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå":"No posts yet"}</div>`;
    }
    function getTrendingTags(windowHours=168, limit=10){
      const idx = loadTagIndex(); const since = Date.now()-windowHours*3600*1000;
      return Object.entries(idx.tags)
        .filter(([_,v])=>v.updatedAt>=since)
        .sort((a,b)=>b[1].count-a[1].count)
        .slice(0,limit)
        .map(([slug,v])=>({slug, name:v.name, count:v.count}));
    }
    function renderTrending(){
      const tr = getTrendingTags();
      document.getElementById("trendingBar").innerHTML =
        tr.length ? tr.map(t=>`<span class="chip">#${t.name} (${t.count})</span>`).join("") : `<span class="text-sm text-gray-500">${getLang()==="th"?"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ó‡πá‡∏Å":"No tags yet"}</span>`;
    }

    /* ============== Compose ============== */
    const dlg = document.getElementById("createModal");
    document.getElementById("openCreatePost").onclick = ()=> dlg.showModal();
    document.getElementById("fabCreate").onclick = ()=> dlg.showModal();
    let PREVIEW_URL = null;
    document.getElementById("file").addEventListener("change", ()=>{
      const box = document.getElementById("preview");
      box.innerHTML=""; PREVIEW_URL=null;
      const f = document.getElementById("file").files?.[0];
      if(!f) return;
      const url = URL.createObjectURL(f); PREVIEW_URL = url;
      if(f.type.startsWith("video")){
        box.innerHTML = `<video src="${url}" controls playsinline class="w-full rounded-xl"></video>`;
      }else{
        box.innerHTML = `<img src="${url}" class="w-full rounded-xl" alt="">`;
      }
    });
    document.getElementById("submitPost").onclick = (e)=>{
      e.preventDefault();
      const text = (document.getElementById("cap").value||"").trim();
      if(!text){ alert(getLang()==="th" ? "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞" : "Please add a caption"); return; }

      const placeId = document.getElementById("placeSelect").value;
      const place = PLACES.find(p=>p.id===placeId);

      const media = PREVIEW_URL
        ? { type: (document.getElementById("file").files?.[0]?.type.startsWith("video")?"video":"image"), src: PREVIEW_URL }
        : null;
      const post = {
        id: "p"+Date.now(),
        user: getLang()==="th" ? "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà" : "New user",
        avatar: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=256&auto=format&fit=crop",
        text,
        media: media || { type:"image", src: place?.photo || "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop" },
        ratio:"4/5", likes: 0,
        place: place ? { id: place.id, name: place.name, province: place.province, category: place.category } : null
      };
      POSTS.unshift(post);
      updateTagIndexFromPost(post);
      document.getElementById("cap").value="";
      document.getElementById("file").value="";
      document.getElementById("preview").innerHTML="";
      PREVIEW_URL=null; document.getElementById("createModal").close();
      renderDiscover();
    };

    document.getElementById("goTag").onclick = ()=>{
      const raw = document.getElementById("searchTag").value.trim().replace(/^#/,"");
      if(!raw) return;
      const slug = slugifyTag(raw);
      const filtered = POSTS.filter(p => extractHashtags(p.text).includes(slug));
      DISCOVER_VIEW="masonry";
      renderDiscover();
      document.getElementById("discoverMasonry").innerHTML = filtered.length
        ? filtered.map(postCard).join("")
        : `<div class="text-sm text-gray-500">${getLang()==="th"?"‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ó‡πá‡∏Å‡∏ô‡∏µ‡πâ":"No posts for this tag"}</div>`;
    };
    /* ============== Explore Data ============== */
    const currentUser = { id:"u_me", name:"‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà", handle:"@tammy", level:"Explorer", points:820, badges:["Verified Explorer"] };
    const places = [
      { id:"p_khaotao", name:"‡∏≠‡πà‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡∏≤‡πÄ‡∏ï‡πà‡∏≤", province:"‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", lat:12.5032, lng:99.9886, openingHours:"06:00‚Äì18:30", tags:["‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢","‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ","‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å"], rating:4.8, crowd:"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", photos:[
        "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop"
      ] },
      { id:"p_somewhere_cnx", name:"Somewhere Cafe", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", category:"‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà", lat:18.7953, lng:98.9525, openingHours:"09:00‚Äì18:00", tags:["‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ß‡∏¥‡∏ß‡∏î‡∏µ","‡∏Å‡∏≤‡πÅ‡∏ü‡∏´‡∏≠‡∏°","‡∏†‡∏π‡πÄ‡∏Ç‡∏≤"], rating:4.5, crowd:"‡∏ô‡πâ‡∏≠‡∏¢", photos:[
        "https://images.unsplash.com/photo-1498654896293-37aacf113fd9?q=80&w=1200&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=1200&auto=format&fit=crop"
      ] },
      { id:"p_monjam", name:"‡∏°‡πà‡∏≠‡∏ô‡πÅ‡∏à‡πà‡∏°", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", lat:18.9370, lng:98.8590, openingHours:"05:30‚Äì19:00", tags:["‡∏†‡∏π‡πÄ‡∏Ç‡∏≤","‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô","‡∏ß‡∏¥‡∏ß‡∏û‡∏≤‡πÇ‡∏ô‡∏£‡∏≤‡∏°‡∏≤"], rating:4.7, crowd:"‡∏°‡∏≤‡∏Å", photos:[
        "https://images.unsplash.com/photo-1528821154947-1aa3d1b749b3?q=80&w=1200&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop"
      ] },
      { id:"p_doisuthep", name:"‡∏î‡∏≠‡∏¢‡∏™‡∏∏‡πÄ‡∏ó‡∏û", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", category:"‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å", lat:18.8047, lng:98.9215, openingHours:"06:00‚Äì20:00", tags:["‡∏ß‡∏±‡∏î","‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß"], rating:4.6, crowd:"‡∏°‡∏≤‡∏Å", photos:[
        "https://images.unsplash.com/photo-1548013146-72479768bada?q=80&w=1200&auto=format&fit=crop"
      ] },
      { id:"p_bangsaen", name:"‡∏´‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô", province:"‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", lat:13.2756, lng:100.9255, openingHours:"24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á", tags:["‡∏ó‡∏∞‡πÄ‡∏•","‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß","‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞"], rating:4.1, crowd:"‡∏°‡∏≤‡∏Å", photos:[
        "https://images.unsplash.com/photo-1500375592092-40eb2168fd21?q=80&w=1200&auto=format&fit=crop",
        "https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1200&auto=format&fit=crop"
      ] }
    ];
    let reviews = [
      { id:"r1", placeId:"p_khaotao", user:"‡∏ô‡∏ô‡∏ó‡πå", userLevel:"Traveler", rating:5, text:"‡∏ß‡∏¥‡∏ß‡πÄ‡∏¢‡πá‡∏ô‡∏™‡∏ö‡∏≤‡∏¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å‡∏™‡∏ß‡∏¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÄ‡∏£‡πá‡∏ß", verifiedVisit:true, date:"2025-10-01", likes:22, coverIndex:0 },
      { id:"r2", placeId:"p_somewhere_cnx", user:"‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà", userLevel:"Explorer", rating:4, text:"‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏µ ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏´‡∏≠‡∏° ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏≤‡∏Å ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢", verifiedVisit:false, date:"2025-09-20", likes:18, coverIndex:1 },
      { id:"r3", placeId:"p_monjam", user:"‡∏û‡∏µ‡∏ó", userLevel:"Local Expert", rating:5, text:"‡∏•‡∏°‡πÄ‡∏¢‡πá‡∏ô ‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÑ‡∏õ‡πÄ‡∏ä‡πâ‡∏≤‡∏î‡∏µ‡∏™‡∏∏‡∏î", verifiedVisit:true, date:"2025-09-12", likes:34, coverIndex:0 },
      { id:"r4", placeId:"p_bangsaen", user:"‡∏ä‡∏¥‡∏ß", userLevel:"Traveler", rating:4, text:"‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î", verifiedVisit:false, date:"2025-08-30", likes:10, coverIndex:0 }
    ];
    const rewardsCatalog = [
      { id:"rw1", name:"‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Grab 50 ‡∏ö‡∏≤‡∏ó", cost:300, desc:"‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" },
      { id:"rw2", name:"‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏ü‡∏£‡∏µ (Cafe Partner)", cost:500, desc:"‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" },
      { id:"rw3", name:"‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡πâ‡∏≤ TripMate", cost:800, desc:"‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ" }
    ];
    const cosmeticsCatalog = [
      { id:"cs_theme_forest", type:"theme", name:"‡∏ò‡∏µ‡∏°‡∏õ‡πà‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", style:"theme-forest", cost:200, preview:"üåø Forest" },
      { id:"cs_theme_sunset", type:"theme", name:"‡∏ò‡∏µ‡∏°‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å", style:"theme-sunset", cost:200, preview:"üåá Sunset" },
      { id:"cs_theme_night",  type:"theme", name:"‡∏ò‡∏µ‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô", style:"theme-night", cost:250, preview:"üåå Night"  },
      { id:"cs_frame_gold", type:"frame", name:"‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏≠‡∏á", style:"frame-gold", cost:180, preview:"ü•á Gold" },
      { id:"cs_frame_neo",  type:"frame", name:"‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πÇ‡∏≠", style:"frame-neo",  cost:150, preview:"üî∑ Neo"  },
      { id:"cs_frame_pastel", type:"frame", name:"‡∏Å‡∏£‡∏≠‡∏ö‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•", style:"frame-pastel", cost:150, preview:"üíú Pastel" },
      { id:"cs_stk_heart", type:"sticker", name:"‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏´‡∏±‡∏ß‡πÉ‡∏à", style:"‚ù§Ô∏è", cost:80,  preview:"‚ù§Ô∏è" },
      { id:"cs_stk_star",  type:"sticker", name:"‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏î‡∏≤‡∏ß",   style:"‚≠ê", cost:80,  preview:"‚≠ê" },
      { id:"cs_stk_cafe",  type:"sticker", name:"‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏Å‡πâ‡∏ß‡∏Å‡∏≤‡πÅ‡∏ü", style:"‚òï", cost:80, preview:"‚òï" },
      { id:"cs_badge_local", type:"badge", name:"Badge: Local Explorer", style:"Local Explorer", cost:120, preview:"üè∑Ô∏è Local" },
      { id:"cs_badge_mvp",   type:"badge", name:"Badge: MVP Reviewer",  style:"MVP Reviewer",   cost:200, preview:"üèÜ MVP" }
    ];

    let TAB = "discover";
    let DISCOVER_VIEW = "masonry";
    let QUERY = "";
    let CAT = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    let PROV = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    let MAX_KM = 80;
    let user = { ...currentUser, points: currentUser.points, badges:[...currentUser.badges] };
    let userLoc = null;

    const kmDist=(a,b,c,d)=>{
      const R=6371,toRad=x=>x*Math.PI/180;
      const dLat=toRad(c-a),dLon=toRad(d-b);
      const A=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
    };
    const fmtKm=km=>km<1?(km*1000).toFixed(0)+" ‡∏°.":km.toFixed(1)+" ‡∏Å‡∏°.";
    const clip=(s,n)=>s.length>n?s.slice(0,n)+"‚Ä¶":s;

    function latestByPlace(){
      const sorted=[...reviews].sort((a,b)=>a.date<b.date?1:-1);
      const map={};
      for(const r of sorted){ if(!map[r.placeId]) map[r.placeId]=r; }
      return map;
    }
    function filteredPlaces(){
      let arr=places.filter(p=>{
        const q=QUERY.trim().toLowerCase();
        const matchesQuery=!q||p.name.toLowerCase().includes(q)||p.tags.join(" ").toLowerCase().includes(q);
        const matchesCategory=CAT==="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"||p.category===CAT;
        const matchesProvince=PROV==="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"||p.province===PROV;
        return matchesQuery && matchesCategory && matchesProvince;
      });
      if(userLoc){
        arr=arr.map(p=>({p,d:kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)}))
              .filter(({d})=>d<=MAX_KM)
              .sort((a,b)=>a.d-b.d)
              .map(({p})=>p);
      }else{
        arr=arr.sort((a,b)=>b.rating-a.rating);
      }
      return arr;
    }

    function tileCard(p, r, dist){
      return `
        <div class="bg-white border rounded-2xl overflow-hidden">
          <img src="${p.photos[0]}" class="w-full h-44 object-cover" />
          <div class="p-4 space-y-2">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-lg font-semibold">${p.name}</div>
                <div class="text-sm text-gray-500">${p.province} ¬∑ ${p.category}</div>
              </div>
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${p.rating.toFixed(1)}</span>
                ${dist?`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">üìç ${dist}</span>`:""}
              </div>
            </div>
            ${r?`<div class="bg-gray-50 rounded-xl p-3 text-sm text-gray-700">‚Äú${clip(r.text,140)}‚Äù
              <div class="mt-1 text-[12px] text-gray-500">‚Äî ${r.user} ¬∑ ${r.userLevel||""}</div></div>`:""}
            <div class="flex flex-wrap gap-2">
              ${p.tags.map(t=>`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">#${t}</span>`).join("")}
            </div>
            <div class="flex items-center justify-between pt-1">
              <div class="text-xs text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ${p.openingHours}</div>
              <div class="flex items-center gap-2">
                <button class="border rounded-full px-3 py-1.5 text-sm" data-act="detail" data-id="${p.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    function renderPromoBanners(){
      const banners=[
        {id:"bn1",title:"‡πÇ‡∏ó‡∏ô‡∏≠‡∏∏‡πà‡∏ô Cozy Caf√©",subtitle:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Æ‡∏¥‡∏ï",tag:"#CafeWeek",color:"from-rose-100 to-amber-50",emoji:"‚òï"},
        {id:"bn2",title:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ",subtitle:"‡∏£‡∏ß‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ",tag:"#NatureNow",color:"from-emerald-100 to-sky-100",emoji:"üåø"},
        {id:"bn3",title:"#‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤",subtitle:"‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏≠‡∏∞",tag:"#HiddenGems",color:"from-indigo-100 to-fuchsia-100",emoji:"üìç"}
      ];
      const container=$("#promoBanners");
      if(!container) return;
      container.innerHTML=banners.map(b=>`
        <div class="min-w-[260px] rounded-2xl p-4 border bg-gradient-to-br ${b.color}">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-xs text-gray-600">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
              <div class="font-semibold leading-tight">${b.title}</div>
              <div class="text-[12px] text-gray-600">${b.subtitle}</div>
            </div>
            <div class="text-xl">${b.emoji}</div>
          </div>
          <div class="mt-2">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border bg-white/60">${b.tag}</span>
          </div>
        </div>
      `).join("");
    }
    function renderTopTags(){
      const tags=["#‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ß‡∏¥‡∏ß‡∏î‡∏µ","#‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥","#‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß","#‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ","#‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏≠‡∏á","#‡∏ó‡∏∞‡πÄ‡∏•","#‡∏†‡∏π‡πÄ‡∏Ç‡∏≤"];
      const container=$("#topTags");
      if(!container) return;
      container.innerHTML=tags.map(t=>`
        <button class="inline-flex items-center rounded-full px-3 py-1.5 text-xs border bg-white hover:bg-gray-50 whitespace-nowrap">${t}</button>
      `).join("");
    }
    function renderDiscoverTiles(){
      const container=$("#discoverTiles");
      if(!container) return;
      const map=latestByPlace();
      const placesList=filteredPlaces();
      container.innerHTML=placesList.length
        ? placesList.map(p=>{
            const review=map[p.id];
            const dist=userLoc?fmtKm(kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)):null;
            return tileCard(p, review, dist);
          }).join("")
        : `<p class="text-sm text-gray-500 col-span-full">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>`;
    }
    function renderDiscover(){
      renderFeed();
      renderTrending();
      const masonry=$("#discoverMasonry");
      const tiles=$("#discoverTiles");
      const toggleBtn=$("#toggleView");
      if(DISCOVER_VIEW==="tiles"){
        renderDiscoverTiles();
        setHidden(masonry, true);
        setHidden(tiles, false);
        if(toggleBtn) toggleBtn.textContent="‡πÇ‡∏´‡∏°‡∏î: ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà";
      }else{
        setHidden(masonry, false);
        setHidden(tiles, true);
        if(toggleBtn) toggleBtn.textContent="‡πÇ‡∏´‡∏°‡∏î: ‡∏†‡∏≤‡∏û‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á";
      }
    }
    function renderSearchChips(){
      const cats=["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î","‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà","‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥","‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å","‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£","‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å"];
      $("#categoryChips").innerHTML=cats.map(c=>`
        <button class="px-3 py-1.5 rounded-full text-sm ${CAT===c?"bg-blue-600 text-white":"border"}" data-cat="${c}">${c}</button>
      `).join("");
      const provs=["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",...Array.from(new Set(places.map(p=>p.province)))];
      $("#provinceChips").innerHTML=provs.map(p=>`
        <button class="px-3 py-1.5 rounded-full text-sm ${PROV===p?"bg-blue-600 text-white":"border"}" data-prov="${p}">${p}</button>
      `).join("");
    }
    function renderSearchResults(){
      const arr=filteredPlaces(); const map=latestByPlace();
      $("#searchResults").innerHTML=arr.length?arr.map(p=>{
        const r=map[p.id];
        const dist=userLoc?fmtKm(kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)):null;
        return tileCard(p,r,dist);
      }).join(""):`<p class="text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</p>`;
    }

    function renderGroups(){
      const container=$("#groupContainer");
      if(!container) return;
      const defaultGroup={
        id:"g_default",
        name:"‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2025",
        members:["‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà","‡∏ô‡∏ô‡∏ó‡πå","‡∏û‡∏µ‡∏ó","‡∏ä‡∏¥‡∏ß"],
        date:"2025-12-30",
        province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà",
        proposals:["p_monjam","p_somewhere_cnx","p_doisuthep"],
        votes:{},
        confirmedPlaceIds:null
      };
      if(!container.dataset.gdata){
        container.dataset.gdata = JSON.stringify(defaultGroup);
      }
      drawGroup(JSON.parse(container.dataset.gdata));
    }
    function drawGroup(group){
      const container=$("#groupContainer");
      const g={...group};
      container.innerHTML=`
        <div class="bg-white border rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="text-lg font-semibold">${g.name}</div>
              <div class="text-sm text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${g.members.join(", ")}</div>
            </div>
            <button id="createGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-3 py-1.5">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
          </div>
          <p class="text-sm text-gray-600">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÄ‡∏™‡∏ô‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‡πÇ‡∏´‡∏ß‡∏ï ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
        </div>
        <div class="bg-white border rounded-2xl p-4 mt-3">
          <div class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</div>
          ${g.proposals.map(pid=>{
            const place=places.find(p=>p.id===pid);
            const votes=Object.values(g.votes).filter(v=>v===pid).length;
            const voted=g.votes[currentUser.name]===pid;
            return `
              <div class="flex items-center justify-between border rounded-xl p-3 mb-2 ${voted?'border-blue-500':''}">
                <div>
                  <div class="font-medium">${place.name}</div>
                  <div class="text-xs text-gray-500">${place.province} ¬∑ ‚≠ê ${place.rating.toFixed(1)}</div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‡πÇ‡∏´‡∏ß‡∏ï: ${votes}</span>
                  <button class="px-3 py-1.5 rounded-full ${voted?'bg-blue-600 text-white':'border'}" data-vote="${pid}">${voted?'‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß':'‡πÇ‡∏´‡∏ß‡∏ï'}</button>
                </div>
              </div>
            `;
          }).join("")}
          <div class="flex items-center justify-between pt-2">
            <div class="text-sm text-gray-500">‡∏Å‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Trip Plan</div>
            <button id="confirmTripBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-3 py-1.5">üó∫Ô∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ</button>
          </div>
        </div>
        <div id="tripSummary"></div>
      `;
      container.querySelectorAll("[data-vote]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          g.votes[currentUser.id]=btn.getAttribute("data-vote");
          container.dataset.gdata=JSON.stringify(g);
          drawGroup(g);
        });
      });
      container.querySelector("#createGroupBtn").addEventListener("click",()=>{
        const newGroup={
          id:"g_"+Date.now(),
          name:"‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡∏µ‡πâ",
          members:["‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà","‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô A","‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô B"],
          date:"2026-02-14",
          province:"‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ",
          proposals:["p_bangsaen","p_khaotao"],
          votes:{},
          confirmedPlaceIds:null
        };
        container.dataset.gdata=JSON.stringify(newGroup);
        drawGroup(newGroup);
      });
      container.querySelector("#confirmTripBtn").addEventListener("click",()=>{
        const counts={};
        g.proposals.forEach(pid=>{ counts[pid]=0; });
        Object.values(g.votes).forEach(pid=>{ counts[pid]=(counts[pid]||0)+1; });
        const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,2).map(([pid])=>pid);
        g.confirmedPlaceIds=top;
        container.dataset.gdata=JSON.stringify(g);
        drawTripSummary(top);
        alert("‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      });
    }
    function drawTripSummary(ids){
      const cont=$("#tripSummary");
      if(!cont) return;
      if(!ids || !ids.length){ cont.innerHTML=""; return; }
      const map=latestByPlace();
      cont.innerHTML=`
        <div class="bg-white border rounded-2xl p-4 mt-3">
          <div class="font-semibold mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ (One-click Plan)</div>
          ${ids.map(pid=>{
            const place=places.find(x=>x.id===pid);
            const r=map[pid];
            return `
              <div class="border rounded-2xl p-3 mb-2">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium">${place.name}</div>
                    <div class="text-xs text-gray-500">${place.province} ¬∑ ${place.category}</div>
                  </div>
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${place.rating.toFixed(1)}</span>
                </div>
                ${r?`<div class="text-sm text-gray-600 mt-1">‚Äú${clip(r.text,120)}‚Äù ‚Äî ${r.user}</div>`:""}
                <div class="mt-2"><button class="border rounded-full px-3 py-1.5 text-sm" data-act="detail" data-id="${place.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></div>
              </div>
            `;
          }).join("")}
          <div class="flex items-center justify-end">
            <button class="border rounded-full px-3 py-1.5" onclick="navigator.clipboard.writeText('Trip Plan ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ä‡∏£‡πå')">‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏ú‡∏ô</button>
          </div>
        </div>
      `;
    }
    function renderRewards(){
      $("#pointsEl").textContent=user.points+" pts";
      $("#badgesEl").textContent="‡πÅ‡∏ö‡∏î‡∏à‡πå: "+(user.badges.join(", ")||"-");
      $("#rewardsList").innerHTML=rewardsCatalog.map(rw=>`
        <div class="bg-white border rounded-2xl p-4 flex items-center justify-between">
          <div>
            <div class="font-semibold">${rw.name}</div>
            <div class="text-sm text-gray-500">${rw.desc}</div>
          </div>
          <div class="flex items-center gap-3">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">${rw.cost} pts</span>
            <button class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-3 py-1.5" data-redeem="${rw.id}">‡πÅ‡∏•‡∏Å</button>
          </div>
        </div>
      `).join("");
      $("#cosmeticsList").innerHTML=cosmeticsCatalog.map(c=>`
        <div class="bg-white border rounded-2xl p-4 flex items-center justify-between">
          <div>
            <div class="font-semibold">${c.name}</div>
            <div class="text-sm text-gray-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${c.type}</div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-sm">${c.preview}</span>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">${c.cost} pts</span>
            <button class="border rounded-full px-3 py-1.5 text-sm" data-buy="${c.id}">‡∏ã‡∏∑‡πâ‡∏≠</button>
          </div>
        </div>
      `).join("");
      qAll("#rewardsList", "[data-redeem]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const rw=rewardsCatalog.find(r=>r.id===btn.getAttribute("data-redeem"));
          if(user.points<rw.cost){ alert("‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÅ‡∏•‡∏Å"); return; }
          user.points-=rw.cost; renderRewards(); renderProfileHeader();
          alert(`‡πÅ‡∏•‡∏Å "${rw.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (mock)`);
        });
      });
      qAll("#cosmeticsList", "[data-buy]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const cs=cosmeticsCatalog.find(x=>x.id===btn.getAttribute("data-buy"));
          if(user.points<cs.cost){ alert("‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á"); return; }
          user.points-=cs.cost;
          const owned = JSON.parse(localStorage.getItem("ownedCosmetics")||"[]");
          if(!owned.includes(cs.id)) owned.push(cs.id);
          localStorage.setItem("ownedCosmetics", JSON.stringify(owned));
          renderRewards(); renderOwnedCosmetics();
          alert(`‡∏ã‡∏∑‡πâ‡∏≠ ${cs.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`);
        });
      });
    }
    function renderOwnedCosmetics(){
      const owned = JSON.parse(localStorage.getItem("ownedCosmetics")||"[]");
      $("#ownedCosmetics").innerHTML = owned.length? owned.map(id=>{
        const cs = cosmeticsCatalog.find(x=>x.id===id);
        return `
          <div class="border rounded-xl p-3 flex items-center justify-between">
            <div class="min-w-0">
              <div class="font-medium truncate">${cs.name}</div>
              <div class="text-xs text-gray-500 truncate">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${cs.type}</div>
            </div>
            <button class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-3 py-1.5 text-sm" data-apply="${cs.id}">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
          </div>
        `;
      }).join("") : `<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á</p>`;
      qAll("#ownedCosmetics", "[data-apply]").forEach(btn=>{
        btn.addEventListener("click",()=>applyCosmetic(btn.getAttribute("data-apply")));
      });
    }
    function applyCosmetic(id){
      const cs = cosmeticsCatalog.find(x=>x.id===id);
      if(!cs) return;
      if(cs.type==="theme"){
        const el = $("#profileTheme");
        el.classList.remove("theme-basic","theme-forest","theme-sunset","theme-night");
        el.classList.add(cs.style);
      } else if(cs.type==="frame"){
        const wrap=$("#avatarWrap");
        wrap.className = "w-16 h-16 overflow-hidden grid place-items-center " + cs.style;
        wrap.style.background="#fff";
      } else if(cs.type==="sticker"){
        const holder = $("#profileStickers");
        const span = document.createElement("span");
        span.className="sticker text-4xl left-6 -top-8";
        span.textContent = cs.style;
        holder.appendChild(span);
        holder.style.height="24px";
      } else if(cs.type==="badge"){
        if(!user.badges.includes(cs.style)) user.badges.push(cs.style);
        renderProfileHeader();
      }
      alert("‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß");
    }
    function renderProfileHeader(){
      $("#userNameEl").textContent=user.name;
      $("#userHandleEl").textContent=user.handle;
      $("#userMetaEl").textContent=`‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${user.level} ¬∑ ‡πÅ‡∏ï‡πâ‡∏°: ${user.points} ¬∑ ‡πÅ‡∏ö‡∏î‡∏à‡πå: ${user.badges.join(", ")||"-"}`;
      const my=reviews.filter(r=>r.user===user.name);
      $("#myReviews").innerHTML=my.length?my.map(r=>{
        const p=places.find(x=>x.id===r.placeId);
        return `
          <div class="bg-white border rounded-2xl p-3">
            <div class="flex items-center justify-between">
              <div class="font-medium">${p.name}</div>
              <div class="text-amber-600">‚≠ê ${r.rating}</div>
            </div>
            <p class="text-sm mt-1">${r.text}</p>
            ${r.verifiedVisit?`<div class="mt-2"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‚úîÔ∏é Verified Visitor</span></div>`:""}
          </div>
        `;
      }).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>`;
    }

    function renderDetail(place){
      const placeReviews=reviews.filter(r=>r.placeId===place.id).sort((a,b)=>a.date<b.date?1:-1);
      const nearby=places.filter(p=>p.id!==place.id).map(p=>({p,d:kmDist(place.lat,place.lng,p.lat,p.lng)}))
        .filter(({d})=>d<=10).sort((a,b)=>a.d-b.d).map(({p})=>p);
      $("#detailContent").innerHTML=`
        <header class="space-y-1">
          <div class="text-xl font-semibold">${place.name}</div>
          <div class="text-sm text-gray-500">${place.province} ¬∑ ${place.category}</div>
          <div class="flex items-center gap-2 mt-1">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${place.rating.toFixed(1)}</span>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">Crowd: ${place.crowd}</span>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ${place.openingHours}</span>
          </div>
        </header>
        <section>
          <div class="font-semibold mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="space-y-2">
            ${placeReviews.length?placeReviews.map(r=>`
              <div class="border rounded-xl p-3">
                <div class="flex items-center justify-between">
                  <div class="font-medium">${r.user} <span class="text-xs text-gray-500">¬∑ ${r.userLevel||""}</span></div>
                  <div class="text-amber-600">‚≠ê ${r.rating}</div>
                </div>
                <p class="text-sm mt-1">${r.text}</p>
                ${r.verifiedVisit?`<div class="mt-2"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‚úîÔ∏é Verified Visitor</span></div>`:""}
              </div>
            `).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>`}
          </div>
        </section>
        <section>
          <div class="font-semibold mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‚â§10 ‡∏Å‡∏°.)</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            ${nearby.length?nearby.map(np=>`
              <div class="border rounded-xl p-3 flex items-center justify-between">
                <div>
                  <div class="font-medium">${np.name}</div>
                  <div class="text-xs text-gray-500">${np.category} ¬∑ ‚≠ê ${np.rating.toFixed(1)}</div>
                </div>
                <button class="px-3 py-1.5 rounded-full border" data-act="detail" data-id="${np.id}">‡∏î‡∏π</button>
              </div>
            `).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ô‡∏µ‡πâ</p>`}
          </div>
        </section>
        <div class="flex items-center justify-end gap-2">
          <button class="px-3 py-1.5 rounded-full border" onclick="navigator.clipboard.writeText('Trip: ${place.name}')">‡πÅ‡∏ä‡∏£‡πå</button>
        </div>
      `;
    }

    const openDetail = (place)=>{ renderDetail(place); setHidden($("#detailModal"), false); };
    const closeDetail = ()=> setHidden($("#detailModal"), true);
    $("#closeDetail").onclick=closeDetail;
    const navButtons=$$("nav [data-tab]");
    function switchTab(tab){
      TAB=tab;
      ["discover","search","groups","rewards","profile"].forEach(id=>setHidden($("#page-"+id), id!==TAB));
      navButtons.forEach(btn=>{
        const active = btn.dataset.tab===TAB;
        btn.classList.toggle("text-blue-600", active);
        btn.classList.toggle("text-gray-600", !active);
      });
      if(TAB==="discover"){ renderDiscover(); }
      if(TAB==="search"){ renderSearchChips(); renderSearchResults(); }
      if(TAB==="groups"){ renderGroups(); }
      if(TAB==="rewards"){ renderRewards(); }
      if(TAB==="profile"){ renderProfileHeader(); renderOwnedCosmetics(); }
    }
    if(navButtons && navButtons.length){ navButtons.forEach(btn=>{ btn.onclick=()=> switchTab(btn.dataset.tab); }); }

    const toggleViewBtn=$("#toggleView");
    if(toggleViewBtn){
      toggleViewBtn.onclick=()=>{
        DISCOVER_VIEW = DISCOVER_VIEW==="masonry" ? "tiles" : "masonry";
        renderDiscover();
      };
    }
    const topSearchEl=document.getElementById("topSearch");
    if(topSearchEl){
      topSearchEl.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){
          const value=e.target.value.trim();
          switchTab("search");
          $("#searchInput").value=value;
          QUERY=value;
          renderSearchResults();
        }
      });
    }
    document.body.addEventListener("click",(e)=>{
      const t=e.target.closest("[data-act]");
      if(!t) return;
      const act=t.getAttribute("data-act");
      if(act==="detail"){
        const id=t.getAttribute("data-id");
        openDetail(places.find(x=>x.id===id));
      }
    });

    $("#applySearchBtn").onclick=()=>{ QUERY=$("#searchInput").value||""; renderSearchResults(); };
    $("#searchInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ QUERY=e.target.value||""; renderSearchResults(); }});
    $("#distSlider").addEventListener("input",(e)=>{ MAX_KM=Number(e.target.value); $("#distVal").textContent=MAX_KM; renderSearchResults(); });
    const catChipsEl = $("#categoryChips"); if(catChipsEl) catChipsEl.addEventListener("click",(e)=>{ const b=e.target.closest("[data-cat]"); if(!b) return; CAT=b.getAttribute("data-cat"); renderSearchChips(); renderSearchResults(); });
    const provChipsEl = $("#provinceChips"); if(provChipsEl) provChipsEl.addEventListener("click",(e)=>{ const b=e.target.closest("[data-prov]"); if(!b) return; PROV=b.getAttribute("data-prov"); renderSearchChips(); renderSearchResults(); });

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition((pos)=>{
        userLoc={lat:pos.coords.latitude,lng:pos.coords.longitude};
        $("#locInfo").textContent="‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì";
        renderSearchResults();
        renderDiscover();
      }, ()=>{
        $("#locInfo").textContent="‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏ó‡∏ô";
      }, {enableHighAccuracy:true, timeout:7000});
    } else {
      $("#locInfo").textContent="‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
    }

    
    initLang();
    renderPromoBanners();
    renderTopTags();
    renderRewards();
    renderProfileHeader();
    renderOwnedCosmetics();
    renderSearchChips();
    populatePlaceSelect();
    switchTab("discover");
  </script>
</body>
</html>
