<!doctype html>
<html lang="th" class="">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TripMate ‚Äî Feed with Dark/Light, TH/EN, Media & Hashtags</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    /* Dark overrides for common utility classes */
    .dark body{ background:#0b0f19; color:#e5e7eb; }
    .dark .bg-white{ background:#0f172a !important; }
    .dark .bg-white\/80{ background:rgba(15,23,42,.8) !important; }
    .dark .border-gray-200{ border-color:#233044 !important; }
    .dark .text-gray-900{ color:#f3f4f6 !important; }
    .dark .text-gray-700{ color:#cbd5e1 !important; }
    .dark .text-gray-500{ color:#94a3b8 !important; }
    .dark .hover\:bg-gray-50:hover{ background:#111827 !important; }

    /* Feed cards */
    .masonry{ column-count: 1; column-gap: 1rem; }
    @media (min-width: 768px){ .masonry{ column-count: 2; } }
    @media (min-width: 1024px){ .masonry{ column-count: 3; } }
    .masonry-item{ break-inside: avoid; }

    .chip{ display:inline-flex; align-items:center; gap:.35rem; font-size:.875rem; padding:.25rem .6rem;
           border-radius:999px; border:1px solid rgba(148,163,184,.35); background:rgba(148,163,184,.12); }
    .chip:hover{ filter:brightness(1.05); }
    .ratio-4-5{ position:relative; padding-bottom:125%; }
    .ratio-4-5 > *{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:.75rem; }
    .btn{ border:1px solid #2563eb; color:#2563eb; padding:.5rem .9rem; border-radius:999px; }
    .btn:hover{ background:#2563eb; color:#fff; }
    .btn-solid{ background:#2563eb; color:#fff; border:0; }
    .btn-solid:hover{ filter:brightness(1.05); }
    .focus-ring:focus-visible{ outline:2px solid #2563eb; outline-offset:2px; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-40 border-b border-gray-200 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-2 flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-500 text-white grid place-items-center font-bold">T</div>
      <div class="font-semibold text-lg text-gray-900">TripMate</div>
      <div class="flex-1"></div>
      <button id="openCreate" class="btn" data-i18n="create">+ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
      <button id="themeToggle" class="chip" aria-label="Toggle theme">üåû</button>
      <button id="langToggle" class="chip" aria-label="Toggle language">TH</button>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Controls -->
    <section class="flex items-center gap-2">
      <div class="text-xl font-semibold text-gray-900" id="feedTitle" data-i18n="feed">‡∏ü‡∏µ‡∏î</div>
      <div class="flex-1"></div>
      <div class="hidden md:flex items-center gap-2">
        <input id="searchTag" class="chip focus-ring" placeholder="#‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏Å" />
        <button id="goTag" class="chip">üîé</button>
      </div>
    </section>

    <!-- Trending -->
    <section>
      <div class="text-sm font-semibold mb-2" data-i18n="trending"># ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡πÅ‡∏£‡∏á</div>
      <div id="trendingBar" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- Feed grid -->
    <section id="feed" class="masonry"></section>
  </main>

  <!-- Create Modal -->
  <dialog id="createModal" class="rounded-2xl p-0 w-[90vw] max-w-xl">
    <form method="dialog" class="p-4 border-b border-gray-200 flex items-center justify-between">
      <div class="font-semibold" data-i18n="create">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</div>
      <button class="chip">‚úï</button>
    </form>
    <div class="p-4 space-y-3">
      <label class="text-sm" data-i18n="caption">‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢</label>
      <textarea id="cap" rows="5" class="w-full border border-gray-200 rounded-xl p-3 focus-ring"
        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå #‡πÅ‡∏ó‡πá‡∏Å ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô #‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ #family)"></textarea>

      <div>
        <label class="text-sm" data-i18n="media">‡∏™‡∏∑‡πà‡∏≠ (‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)</label>
        <input id="file" type="file" accept="image/*,video/mp4,video/webm"
               class="mt-1 w-full border border-gray-200 rounded-lg p-2 focus-ring" />
        <div id="preview" class="mt-2"></div>
      </div>

      <div class="flex items-center justify-end gap-2 pt-2">
        <button class="chip" formmethod="dialog" data-i18n="cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="submitPost" class="btn-solid" data-i18n="post">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
      </div>
    </div>
  </dialog>

  <script>
    /* ============== Language & Theme ============== */
    const I18N = {
      th: { create:"+ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß", feed:"‡∏ü‡∏µ‡∏î", trending:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡πÅ‡∏£‡∏á", caption:"‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢", media:"‡∏™‡∏∑‡πà‡∏≠ (‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)", cancel:"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", post:"‡πÇ‡∏û‡∏™‡∏ï‡πå", searchPH:"#‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏Å" },
      en: { create:"+ Create Post", feed:"Feed", trending:"Trending now", caption:"Caption", media:"Media (image/video)", cancel:"Cancel", post:"Post", searchPH:"#Search tag" }
    };
    const getLang = () => localStorage.getItem("lang") || "th";
    function applyI18N(){
      const L = I18N[getLang()];
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        if (L[key]) el.textContent = L[key];
      });
      document.getElementById("langToggle").textContent = getLang().toUpperCase();
      document.getElementById("searchTag").placeholder = L.searchPH;
    }
    function initLang(){
      if(!localStorage.getItem("lang")) localStorage.setItem("lang","th"); // default = ‡πÑ‡∏ó‡∏¢
      applyI18N();
      document.getElementById("langToggle").onclick = ()=>{
        const next = getLang()==="th" ? "en" : "th";
        localStorage.setItem("lang", next);
        applyI18N(); renderFeed(); renderTrending();
      };
    }
    function initTheme(){
      const saved = localStorage.getItem("theme") || "light";
      document.documentElement.classList.toggle("dark", saved==="dark");
      document.getElementById("themeToggle").textContent = saved==="dark" ? "üåô" : "üåû";
      document.getElementById("themeToggle").onclick = ()=>{
        const on = document.documentElement.classList.contains("dark");
        document.documentElement.classList.toggle("dark", !on);
        localStorage.setItem("theme", on ? "light" : "dark");
        document.getElementById("themeToggle").textContent = on ? "üåû" : "üåô";
      };
    }

    /* ============== Hashtags ============== */
    const hashtagRegex = /(^|\s)#([A-Za-z0-9_\u0E00-\u0E7F]{2,50})/g;
    function normalizeTag(raw){
      const clean = raw.normalize("NFC").trim().replace(/^#/,"");
      const lower = clean.toLowerCase();
      const kept = Array.from(lower).filter(ch=>/[a-z0-9_\u0E00-\u0E7F]/i.test(ch)).join("");
      return kept;
    }
    const slugifyTag = normalizeTag;
    function extractHashtags(text){
      const s = new Set();
      (text||"").replace(hashtagRegex, (_m,_w,tag)=>{
        const slug = slugifyTag(tag);
        if(slug.length>=2 && slug.length<=50) s.add(slug);
      });
      return [...s];
    }
    function linkifyHashtags(text){
      return (text||"").replace(hashtagRegex, (_m, ws, tag) => {
        const slug = slugifyTag(tag);
        return `${ws}<span class="chip">#${tag}</span>`;
      });
    }

    /* ============== Data ============== */
    const POSTS = [
      {
        id: "p1",
        user: "Pim",
        avatar: "https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?q=80&w=256&auto=format&fit=crop",
        text: "‡∏ß‡∏±‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡πÜ ‡∏ó‡∏µ‡πà #‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ ‡πÅ‡∏ß‡∏∞ #‡∏ï‡∏•‡∏≤‡∏î‡∏ß‡∏±‡∏î‡∏®‡∏≤‡∏•‡πÄ‡∏à‡πâ‡∏≤ ‡∏≠‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏Å ü•∞ #local_food #photo_spot",
        media: { type:"image", src:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop" },
        ratio: "4/5", likes: 12
      },
      {
        id: "p2",
        user: "Non",
        avatar: "https://images.unsplash.com/photo-1552374196-c4e7ffc6e126?q=80&w=256&auto=format&fit=crop",
        text: "‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏∏‡∏î‡∏°‡∏±‡∏ô‡∏ó‡∏µ‡πà #dreamworld #theme_park #family",
        media: { type:"video", src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" },
        ratio: "4/5", likes: 7
      }
    ];
    const TAG_INDEX_KEY = "tripmate_tags";
    function loadTagIndex(){ try{ return JSON.parse(localStorage.getItem(TAG_INDEX_KEY)||'{"tags":{}}'); }catch{return {tags:{}}} }
    function saveTagIndex(x){ localStorage.setItem(TAG_INDEX_KEY, JSON.stringify(x)); }
    function updateTagIndexFromPost(post){
      const idx = loadTagIndex(); const now = Date.now();
      const list = extractHashtags(post.text).map(slug=>({slug, name: slug}));
      for(const t of list){
        const cur = idx.tags[t.slug] || { name:t.name, count:0, postIds:[], placeIds:[], updatedAt:now };
        cur.name ||= t.name; cur.count += 1;
        if(!cur.postIds.includes(post.id)) cur.postIds.push(post.id);
        cur.updatedAt = now;
        idx.tags[t.slug] = cur;
      }
      saveTagIndex(idx);
    }
    // seed initial index
    POSTS.forEach(updateTagIndexFromPost);

    /* ============== Feed Rendering ============== */
    function postCard(p){
      const pb = "ratio-4-5";
      let media = "";
      if(p.media?.type==="video"){
        media = `<video src="${p.media.src}" controls playsinline></video>`;
      }else{
        media = `<img src="${p.media?.src}" alt="">`;
      }
      return `
        <article class="masonry-item bg-white border border-gray-200 rounded-2xl overflow-hidden mb-4">
          <div class="p-3 flex items-center gap-3">
            <img src="${p.avatar}" class="w-9 h-9 rounded-full object-cover" alt="${p.user}"/>
            <div class="font-medium text-gray-900">${p.user}</div>
            <div class="ml-auto text-sm text-gray-500">‚ù§Ô∏è ${p.likes}</div>
          </div>
          <div class="px-3 pb-3">
            <div class="${pb}">${media}</div>
          </div>
          <div class="px-3 pb-4 -mt-2">
            <div class="text-sm text-gray-700">${linkifyHashtags(p.text)}</div>
            <div class="mt-2 flex flex-wrap gap-2">
              ${extractHashtags(p.text).map(t=>`<span class="chip">#${t}</span>`).join("")}
            </div>
          </div>
        </article>
      `;
    }
    function renderFeed(){
      const box = document.getElementById("feed");
      box.innerHTML = POSTS.map(postCard).join("");
    }
    function getTrendingTags(windowHours=168, limit=10){
      const idx = loadTagIndex(); const since = Date.now()-windowHours*3600*1000;
      return Object.entries(idx.tags)
        .filter(([_,v])=>v.updatedAt>=since)
        .sort((a,b)=>b[1].count-a[1].count)
        .slice(0,limit)
        .map(([slug,v])=>({slug, name:v.name, count:v.count}));
    }
    function renderTrending(){
      const tr = getTrendingTags();
      document.getElementById("trendingBar").innerHTML =
        tr.map(t=>`<span class="chip">#${t.name} (${t.count})</span>`).join("");
    }

    /* ============== Compose ============== */
    const dlg = document.getElementById("createModal");
    document.getElementById("openCreate").onclick = ()=> dlg.showModal();
    let PREVIEW_URL = null;
    document.getElementById("file").addEventListener("change", ()=>{
      const box = document.getElementById("preview");
      box.innerHTML=""; PREVIEW_URL=null;
      const f = document.getElementById("file").files?.[0];
      if(!f) return;
      const url = URL.createObjectURL(f); PREVIEW_URL = url;
      if(f.type.startsWith("video")){
        box.innerHTML = `<video src="${url}" controls playsinline class="w-full rounded-xl"></video>`;
      }else{
        box.innerHTML = `<img src="${url}" class="w-full rounded-xl" alt="">`;
      }
    });
    document.getElementById("submitPost").onclick = (e)=>{
      e.preventDefault();
      const text = (document.getElementById("cap").value||"").trim();
      if(!text){ alert(getLang()==="th" ? "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞" : "Please add a caption"); return; }
      const media = PREVIEW_URL
        ? { type: (document.getElementById("file").files?.[0]?.type.startsWith("video")?"video":"image"), src: PREVIEW_URL }
        : null;
      const post = {
        id: "p"+Date.now(),
        user: getLang()==="th" ? "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà" : "New user",
        avatar: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=256&auto=format&fit=crop",
        text, media: media || { type:"image", src:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop" },
        ratio:"4/5", likes: 0
      };
      POSTS.unshift(post);
      updateTagIndexFromPost(post);
      // reset form
      document.getElementById("cap").value=""; document.getElementById("file").value=""; document.getElementById("preview").innerHTML="";
      PREVIEW_URL=null; dlg.close();
      renderFeed(); renderTrending();
    };

    /* ============== Tag quick search ============== */
    document.getElementById("goTag").onclick = ()=>{
      const raw = document.getElementById("searchTag").value.trim().replace(/^#/,"");
      if(!raw) return;
      const slug = slugifyTag(raw);
      // quick filter feed by tag (client-only)
      const filtered = POSTS.filter(p => extractHashtags(p.text).includes(slug));
      document.getElementById("feed").innerHTML = filtered.length
        ? filtered.map(postCard).join("")
        : `<div class="text-sm text-gray-500">${getLang()==="th"?"‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ó‡πá‡∏Å‡∏ô‡∏µ‡πâ":"No posts for this tag"}</div>`;
    };

    /* ============== Boot ============== */
    initTheme();
    initLang();
    renderFeed();
    renderTrending();
  </script>
</body>
</html>
