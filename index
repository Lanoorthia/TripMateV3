<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TripMate ‚Äî Lifestyle Social Prototype</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
    .glass{backdrop-filter: blur(8px); background: rgba(255,255,255,.6)}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- TOP BAR: lifestyle style -->
  <header class="sticky top-0 z-40 border-b bg-white/80 backdrop-blur">
    <div class="max-w-4xl mx-auto px-4 py-2 flex items-center gap-3">
      <div class="flex items-center gap-2 flex-1">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-500 text-white grid place-items-center font-bold">T</div>
        <div class="font-extrabold tracking-tight">TripMate</div>
        <!-- search pill -->
        <div class="hidden sm:flex items-center gap-2 ml-3 flex-1 max-w-md glass rounded-full px-3 py-1.5 border">
          <span>üîé</span>
          <input id="topSearch" class="bg-transparent outline-none text-sm w-full" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢ ¬∑ ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà ¬∑ ‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß" />
        </div>
      </div>
      <a href="https://forms.gle/JuJ2WWLeiRyTQSNU6" target="_blank" rel="noopener"
         class="border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white transition rounded-full px-4 py-1.5 text-sm">
        ‡∏™‡πà‡∏á‡∏ü‡∏µ‡∏î‡πÅ‡∏ö‡πá‡∏Å
      </a>
    </div>
  </header>

  <!-- PAGE -->
  <main class="max-w-4xl mx-auto px-4 py-4 pb-28">
    <!-- DISCOVER -->
    <section id="page-discover" class="space-y-4">

      <!-- Stories / Topics rail -->
      <div class="flex items-center justify-between">
        <div class="font-semibold">For you</div>
        <button id="openCreatePost" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-4 py-2 text-sm">+ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
      </div>
      <div id="storiesRail" class="flex gap-3 overflow-x-auto no-scrollbar pb-1"></div>

      <!-- Banners (promos & hashtags) -->
      <div id="promoBanners" class="flex gap-3 overflow-x-auto no-scrollbar"></div>
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-700 flex items-center gap-2">üî• ‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
        <div class="text-xs text-gray-500">‡∏õ‡∏£‡∏±‡∏ö feed ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏ô‡πÉ‡∏à</div>
      </div>
      <div id="topTags" class="flex gap-2 overflow-x-auto no-scrollbar"></div>

      <!-- Mode toggle -->
      <div class="flex items-center gap-2 mt-1">
        <button id="modePostsBtn" class="bg-blue-600 text-white rounded-full px-3 py-1.5 text-sm">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button id="modeTilesBtn" class="border border-gray-300 rounded-full px-3 py-1.5 text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</button>
      </div>

      <!-- FEED / TILES -->
      <div id="discoverContent" class="grid grid-cols-1 gap-3"></div>
    </section>

    <!-- SEARCH -->
    <section id="page-search" class="hidden space-y-3">
      <div class="flex items-center gap-2">
        <div class="relative flex-1">
          <input id="searchInput" class="w-full border rounded-xl pl-9 pr-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£...">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">üîé</span>
        </div>
        <button id="applySearchBtn" class="border rounded-full px-3 py-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤üîé</button>
      </div>
      <div id="categoryChips" class="flex gap-2 overflow-x-auto no-scrollbar py-1"></div>
      <div id="provinceChips" class="flex gap-2 overflow-x-auto no-scrollbar py-1"></div>
      <div class="flex items-center gap-3 text-sm text-gray-600"><span>üß≠ ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</span> <span id="distVal">80</span> ‡∏Å‡∏°.</div>
      <input id="distSlider" type="range" min="5" max="200" step="5" value="80" class="w-full accent-blue-600" />
      <div id="locInfo" class="text-xs text-gray-500"></div>
      <div id="searchResults" class="grid grid-cols-1 gap-3"></div>
    </section>

    <!-- GROUPS -->
    <section id="page-groups" class="hidden space-y-4">
      <div id="groupContainer"></div>
    </section>

    <!-- REWARDS -->
    <section id="page-rewards" class="hidden space-y-4">
      <div class="bg-white border rounded-2xl p-4 flex items-center justify-between">
        <div>
          <div class="text-lg font-semibold">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
          <div id="pointsEl" class="text-2xl font-bold text-blue-600">0 pts</div>
          <div id="badgesEl" class="mt-1 text-sm text-gray-500">‡πÅ‡∏ö‡∏î‡∏à‡πå: -</div>
        </div>
        <div class="text-4xl">üèÖ</div>
      </div>
      <div id="rewardsList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
    </section>

    <!-- PROFILE -->
    <section id="page-profile" class="hidden space-y-4">
      <div class="bg-white border rounded-2xl p-4 flex items-center justify-between">
        <div>
          <div class="text-xl font-semibold">
            <span id="userNameEl">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
            <span id="userHandleEl" class="text-sm text-gray-500">@handle</span>
          </div>
          <div id="userMetaEl" class="text-sm text-gray-500">‡∏£‡∏∞‡∏î‡∏±‡∏ö: - ¬∑ ‡πÅ‡∏ï‡πâ‡∏°: - ¬∑ ‡πÅ‡∏ö‡∏î‡∏à‡πå: -</div>
        </div>
        <div class="text-4xl">üë§</div>
      </div>
      <div>
        <div class="font-semibold mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
        <div id="myReviews" class="space-y-2"></div>
      </div>
    </section>
  </main>

  <!-- FAB -->
  <button id="fabCreate" class="fixed bottom-20 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg px-4 py-3 text-sm">
    + ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
  </button>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 inset-x-0 bg-white border-t z-40">
    <div class="max-w-4xl mx-auto grid grid-cols-5 text-sm">
      <button data-tab="discover" class="py-3 flex flex-col items-center text-blue-600">üè†<span class="text-xs">‡∏ü‡∏µ‡∏î</span></button>
      <button data-tab="search" class="py-3 flex flex-col items-center text-gray-600">üîé<span class="text-xs">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span></button>
      <button data-tab="groups" class="py-3 flex flex-col items-center text-gray-600">üë•<span class="text-xs">‡∏Å‡∏•‡∏∏‡πà‡∏°</span></button>
      <button data-tab="rewards" class="py-3 flex flex-col items-center text-gray-600">‚≠ê<span class="text-xs">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span></button>
      <button data-tab="profile" class="py-3 flex flex-col items-center text-gray-600">üë§<span class="text-xs">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></button>
    </div>
  </nav>

  <!-- Modals -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black/50 z-50 p-4">
    <div class="bg-white w-full max-w-2xl mx-auto mt-[10vh] rounded-2xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        <button id="closeDetail" class="px-3 py-1.5 rounded-xl hover:bg-gray-100">‚úï</button>
      </div>
      <div id="detailContent" class="space-y-4"></div>
    </div>
  </div>

  <div id="createModal" class="hidden fixed inset-0 bg-black/50 z-50 p-4">
    <div class="bg-white w-full max-w-lg mx-auto mt-[10vh] rounded-2xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="text-lg font-semibold">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</div>
        <button id="closeCreate" class="px-3 py-1.5 rounded-xl hover:bg-gray-100">‚úï</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
          <select id="createPlace" class="w-full border rounded-md p-2 mt-1"></select>
        </div>
        <div>
          <label class="text-sm">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="createRateLabel">5</span> ‡∏î‡∏≤‡∏ß</label>
          <input id="createRate" type="range" min="1" max="5" step="1" value="5" class="w-full accent-blue-600" />
        </div>
        <div>
          <label class="text-sm">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</label>
          <textarea id="createText" rows="4" class="w-full border rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡πÄ‡∏•‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"></textarea>
        </div>
        <div id="verifyHint" class="text-sm text-gray-500">* ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Verified</div>
        <div class="flex items-center justify-end gap-2">
          <button id="cancelCreate" class="border border-gray-300 rounded-2xl px-4 py-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="submitCreate" class="bg-blue-600 hover:bg-blue-700 text-white rounded-2xl px-4 py-2">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Data (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---------- */
    const currentUser = { id:"u_me", name:"‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà", handle:"@tammy", level:"Explorer", points:520, badges:["Verified Explorer"] };
    const places = [
      { id:"p_khaotao", name:"‡∏≠‡πà‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡∏≤‡πÄ‡∏ï‡πà‡∏≤", province:"‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", lat:12.5032, lng:99.9886, openingHours:"06:00‚Äì18:30", tags:["‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢","‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ","‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å"], rating:4.8, crowd:"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", photos:["https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop"] },
      { id:"p_somewhere_cnx", name:"Somewhere Cafe", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", category:"‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà", lat:18.7953, lng:98.9525, openingHours:"09:00‚Äì18:00", tags:["‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ß‡∏¥‡∏ß‡∏î‡∏µ","‡∏Å‡∏≤‡πÅ‡∏ü‡∏´‡∏≠‡∏°","‡∏†‡∏π‡πÄ‡∏Ç‡∏≤"], rating:4.5, crowd:"‡∏ô‡πâ‡∏≠‡∏¢", photos:["https://images.unsplash.com/photo-1498654896293-37aacf113fd9?q=80&w=1200&auto=format&fit=crop"] },
      { id:"p_monjam", name:"‡∏°‡πà‡∏≠‡∏ô‡πÅ‡∏à‡πà‡∏°", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", lat:18.9370, lng:98.8590, openingHours:"05:30‚Äì19:00", tags:["‡∏†‡∏π‡πÄ‡∏Ç‡∏≤","‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô","‡∏ß‡∏¥‡∏ß‡∏û‡∏≤‡πÇ‡∏ô‡∏£‡∏≤‡∏°‡∏≤"], rating:4.7, crowd:"‡∏°‡∏≤‡∏Å", photos:["https://images.unsplash.com/photo-1528821154947-1aa3d1b749b3?q=80&w=1200&auto=format&fit=crop"] },
      { id:"p_doisuthep", name:"‡∏î‡∏≠‡∏¢‡∏™‡∏∏‡πÄ‡∏ó‡∏û", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", category:"‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å", lat:18.8047, lng:98.9215, openingHours:"06:00‚Äì20:00", tags:["‡∏ß‡∏±‡∏î","‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß"], rating:4.6, crowd:"‡∏°‡∏≤‡∏Å", photos:["https://images.unsplash.com/photo-1548013146-72479768bada?q=80&w=1200&auto=format&fit=crop"] },
      { id:"p_bangsaen", name:"‡∏´‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô", province:"‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", lat:13.2756, lng:100.9255, openingHours:"24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á", tags:["‡∏ó‡∏∞‡πÄ‡∏•","‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß","‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞"], rating:4.1, crowd:"‡∏°‡∏≤‡∏Å", photos:["https://images.unsplash.com/photo-1500375592092-40eb2168fd21?q=80&w=1200&auto=format&fit=crop"] },
    ];
    let reviews = [
      { id:"r1", placeId:"p_khaotao", user:"‡∏ô‡∏ô‡∏ó‡πå", userLevel:"Traveler", rating:5, text:"‡∏ß‡∏¥‡∏ß‡πÄ‡∏¢‡πá‡∏ô‡∏™‡∏ö‡∏≤‡∏¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å‡∏™‡∏ß‡∏¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÄ‡∏£‡πá‡∏ß ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏¥‡∏°‡∏ó‡∏≤‡∏á", verifiedVisit:true, date:"2025-10-01", likes:22 },
      { id:"r2", placeId:"p_somewhere_cnx", user:"‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà", userLevel:"Explorer", rating:4, text:"‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏µ ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏´‡∏≠‡∏° ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏≤‡∏Å ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢", verifiedVisit:false, date:"2025-09-20", likes:18 },
      { id:"r3", placeId:"p_monjam", user:"‡∏û‡∏µ‡∏ó", userLevel:"Local Expert", rating:5, text:"‡∏•‡∏°‡πÄ‡∏¢‡πá‡∏ô ‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏õ‡πÄ‡∏ä‡πâ‡∏≤ ‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤", verifiedVisit:true, date:"2025-09-12", likes:34 },
      { id:"r4", placeId:"p_bangsaen", user:"‡∏ä‡∏¥‡∏ß", userLevel:"Traveler", rating:4, text:"‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î", verifiedVisit:false, date:"2025-08-30", likes:10 },
    ];
    const rewardsCatalog = [
      { id:"rw1", name:"‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Grab 50 ‡∏ö‡∏≤‡∏ó", cost:300, desc:"‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" },
      { id:"rw2", name:"‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏ü‡∏£‡∏µ (Cafe Partner)", cost:500, desc:"‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" },
      { id:"rw3", name:"‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡πâ‡∏≤ TripMate", cost:800, desc:"‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ" },
    ];

    /* ---------- State & helpers ---------- */
    let TAB="discover", MODE="posts", QUERY="", CAT="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", PROV="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", MAX_KM=80;
    let user = JSON.parse(JSON.stringify(currentUser));
    let userLoc = null;

    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const setHidden = (el,hidden)=> el.classList.toggle("hidden", hidden);
    const kmDist=(a,b,c,d)=>{const R=6371,toRad=x=>x*Math.PI/180;const dLat=toRad(c-a),dLon=toRad(d-b);const A=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A))};
    const fmtKm=km=>km<1?(km*1000).toFixed(0)+" ‡∏°.":km.toFixed(1)+" ‡∏Å‡∏°.";
    const clip=(s,n)=>s.length>n?s.slice(0,n)+"‚Ä¶":s;

    const latestByPlace=()=>{const sorted=[...reviews].sort((a,b)=>a.date<b.date?1:-1);const m={};for(const r of sorted) if(!m[r.placeId]) m[r.placeId]=r;return m;}

    function filteredPlaces(){
      let arr=places.filter(p=>{
        const q=QUERY.trim().toLowerCase();
        const mq=!q||p.name.toLowerCase().includes(q)||p.tags.join(" ").toLowerCase().includes(q);
        const mc=CAT==="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"||p.category===CAT;
        const mp=PROV==="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"||p.province===PROV;
        return mq&&mc&&mp;
      });
      if(userLoc){
        arr=arr.map(p=>({p,d:kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)}))
              .filter(({d})=>d<=MAX_KM)
              .sort((a,b)=>a.d-b.d).map(({p})=>p);
      }else{
        arr=arr.sort((a,b)=>b.rating-a.rating);
      }
      return arr;
    }

    /* ---------- UI Renders ---------- */
    function renderNav(){
      $$(".grid [data-tab]").forEach(btn=>{
        btn.classList.toggle("text-blue-600",btn.dataset.tab===TAB);
        btn.classList.toggle("text-gray-600",btn.dataset.tab!==TAB);
      });
      setHidden($("#page-discover"),TAB!=="discover");
      setHidden($("#page-search"),TAB!=="search");
      setHidden($("#page-groups"),TAB!=="groups");
      setHidden($("#page-rewards"),TAB!=="rewards");
      setHidden($("#page-profile"),TAB!=="profile");
    }

    function renderStories(){
      // story = place photos/topics
      const topics = [
        {label:"#CafeWeek", photo:places[1].photos[0]},
        {label:"#NatureNow", photo:places[2].photos[0]},
        {label:"#‡∏ó‡∏∞‡πÄ‡∏•", photo:places[4].photos[0]},
        {label:"#HiddenGems", photo:places[0].photos[0]},
        {label:"#‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", photo:places[3].photos[0]},
      ];
      $("#storiesRail").innerHTML = topics.map(t => `
        <button class="flex flex-col items-center gap-1">
          <span class="w-16 h-16 rounded-full ring-2 ring-blue-500 overflow-hidden">
            <img src="${t.photo}" class="w-full h-full object-cover" />
          </span>
          <span class="text-[11px] text-gray-700">${t.label}</span>
        </button>
      `).join("");
    }

    function renderBanners(){
      const banners=[
        {id:"bn1",title:"‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡πÇ‡∏ó‡∏ô‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô",subtitle:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Æ‡∏¥‡∏ï",tag:"#CafeWeek",color:"from-rose-100 to-amber-50",emoji:"‚òï"},
        {id:"bn2",title:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ",subtitle:"‡∏£‡∏ß‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ",tag:"#NatureNow",color:"from-emerald-100 to-sky-100",emoji:"üåø"},
        {id:"bn3",title:"#‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤",subtitle:"‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏≠‡∏∞",tag:"#HiddenGems",color:"from-indigo-100 to-fuchsia-100",emoji:"üìç"},
      ];
      $("#promoBanners").innerHTML=banners.map(b=>`
        <div class="min-w-[280px] rounded-2xl p-4 border bg-gradient-to-br ${b.color}">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-xs text-gray-600">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
              <div class="font-semibold leading-tight">${b.title}</div>
              <div class="text-[12px] text-gray-600">${b.subtitle}</div>
            </div>
            <div class="text-xl">${b.emoji}</div>
          </div>
          <div class="mt-2">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border bg-white/60">${b.tag}</span>
          </div>
        </div>
      `).join("");
    }

    function renderTopTags(){
      const tags=["#‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ß‡∏¥‡∏ß‡∏î‡∏µ","#‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥","#‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß","#‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ","#‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏≠‡∏á","#‡∏ó‡∏∞‡πÄ‡∏•","#‡∏†‡∏π‡πÄ‡∏Ç‡∏≤","#workshop","#‡πÅ‡∏ü‡∏ô"];
      $("#topTags").innerHTML=tags.map(t=>`
        <button class="inline-flex items-center rounded-full px-3 py-1.5 text-xs border bg-white hover:bg-gray-50 whitespace-nowrap">${t}</button>
      `).join("");
    }

    function socialCard(post){
      // lifestyle social: big image, user row, action bar
      return `
        <article class="bg-white border rounded-2xl overflow-hidden">
          <header class="px-4 pt-3 pb-2 flex items-center gap-3">
            <div class="w-9 h-9 rounded-full overflow-hidden">
              <img src="${post.place.photos[0]}" class="w-full h-full object-cover"/>
            </div>
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">${post.user} <span class="text-xs text-gray-500">¬∑ ${post.userLevel||""}</span></div>
              <div class="text-[11px] text-gray-500 truncate">${post.place.name} ¬∑ ${post.place.province}</div>
            </div>
            <div class="ml-auto text-amber-600 text-sm">‚≠ê ${post.rating}</div>
          </header>
          <figure class="relative">
            <img src="${post.place.photos[0]}" class="w-full h-64 object-cover"/>
            <figcaption class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/60 to-transparent text-white">
              <div class="text-sm font-medium">${post.place.name}</div>
              <p class="text-xs opacity-90 line-clamp-3">${post.text}</p>
            </figcaption>
          </figure>
          <div class="px-4 py-2 flex items-center justify-between text-sm">
            <div class="flex items-center gap-3 text-gray-600">
              <button class="flex items-center gap-1">‚ù§Ô∏è <span>${post.likes}</span></button>
              <button class="flex items-center gap-1" data-act="detail" data-id="${post.place.id}">üìç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
            </div>
            <div class="flex items-center gap-2">
              <button class="border rounded-full px-3 py-1.5 text-sm" data-act="share" data-text="‡∏£‡∏µ‡∏ß‡∏¥‡∏ß: ${post.place.name} ‡πÇ‡∏î‡∏¢ ${post.user}">‡πÅ‡∏ä‡∏£‡πå</button>
            </div>
          </div>
        </article>
      `;
    }

    function tileCard(p, r, dist){
      return `
        <div class="bg-white border rounded-2xl overflow-hidden">
          <img src="${p.photos[0]}" class="w-full h-44 object-cover" />
          <div class="p-4 space-y-2">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-lg font-semibold">${p.name}</div>
                <div class="text-sm text-gray-500">${p.province} ¬∑ ${p.category}</div>
              </div>
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${p.rating.toFixed(1)}</span>
                ${dist?`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">üìç ${dist}</span>`:""}
              </div>
            </div>
            ${r?`<div class="bg-gray-50 rounded-xl p-3 text-sm text-gray-700">‚Äú${clip(r.text,140)}‚Äù
              <div class="mt-1 text-[12px] text-gray-500">‚Äî ${r.user} ¬∑ ${r.userLevel||""}</div></div>`:""}
            <div class="flex flex-wrap gap-2">
              ${p.tags.map(t=>`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">#${t}</span>`).join("")}
            </div>
            <div class="flex items-center justify-between pt-1">
              <div class="text-xs text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ${p.openingHours}</div>
              <div class="flex items-center gap-2">
                <button class="border rounded-full px-3 py-1.5 text-sm" data-act="detail" data-id="${p.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                <button class="rounded-full px-3 py-1.5 text-sm bg-blue-600 text-white" data-act="share" data-text="TripMate ¬∑ ${p.name} ¬∑ ${p.province}">‡πÅ‡∏ä‡∏£‡πå</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderDiscover(){
      const container=$("#discoverContent");
      if(MODE==="posts"){
        const posts=[...reviews].map(r=>({...r,place:places.find(p=>p.id===r.placeId)})).sort((a,b)=>a.date<b.date?1:-1);
        container.innerHTML=posts.map(socialCard).join("");
      } else {
        const map=latestByPlace(); const arr=filteredPlaces();
        container.innerHTML=arr.map(p=>{
          const r=map[p.id];
          const dist=userLoc?fmtKm(kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)):null;
          return tileCard(p,r,dist);
        }).join("");
      }
    }

    function renderSearchChips(){
      const cats=["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î","‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà","‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥","‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å","‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£","‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å"];
      $("#categoryChips").innerHTML=cats.map(c=>`
        <button class="px-3 py-1.5 rounded-full text-sm ${CAT===c?"bg-blue-600 text-white":"border"}" data-cat="${c}">${c}</button>
      `).join("");
      const provs=["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",...Array.from(new Set(places.map(p=>p.province)))];
      $("#provinceChips").innerHTML=provs.map(p=>`
        <button class="px-3 py-1.5 rounded-full text-sm ${PROV===p?"bg-blue-600 text-white":"border"}" data-prov="${p}">${p}</button>
      `).join("");
    }

    function renderSearchResults(){
      const arr=filteredPlaces(); const map=latestByPlace();
      $("#searchResults").innerHTML=arr.length?arr.map(p=>{
        const r=map[p.id];
        const dist=userLoc?fmtKm(kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)):null;
        return tileCard(p,r,dist);
      }).join(""):`<p class="text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</p>`;
    }

    function renderGroups(){
      const container=$("#groupContainer");
      const existing=container.getAttribute("data-group")==="1";
      if(!existing){
        container.innerHTML=`
          <div class="bg-white border rounded-2xl p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="text-lg font-semibold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</div>
              <button id="createGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-3 py-1.5">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <p class="text-sm text-gray-600">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÄ‡∏™‡∏ô‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î "‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
          </div>
          <div id="groupArea" class="mt-3"></div>
        `;
        container.setAttribute("data-group","1");
        $("#createGroupBtn").onclick=()=>{
          const g={id:"g_"+Date.now(), name:"‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2025", members:["‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà","‡∏ô‡∏ô‡∏ó‡πå","‡∏û‡∏µ‡∏ó","‡∏ä‡∏¥‡∏ß"], date:"2025-12-30", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", proposals:["p_monjam","p_somewhere_cnx","p_doisuthep"], votes:{}, confirmedPlaceIds:null};
          container.dataset.gdata=JSON.stringify(g);
          drawGroup(g);
        };
      } else if(container.dataset.gdata){
        drawGroup(JSON.parse(container.dataset.gdata));
      }
    }

    function drawGroup(g){
      const area=$("#groupArea");
      area.innerHTML=`
        <div class="bg-white border rounded-2xl p-4 flex items-center justify-between">
          <div>
            <div class="text-lg font-semibold">${g.name}</div>
            <div class="text-sm text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${g.members.join(", ")}</div>
          </div>
          <button class="border rounded-full px-3 py-1.5" onclick="navigator.clipboard.writeText('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°: ${g.name}')">‡πÅ‡∏ä‡∏£‡πå</button>
        </div>
        <div class="bg-white border rounded-2xl p-4 mt-3">
          <div class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</div>
          ${g.proposals.map(pid=>{
            const p=places.find(x=>x.id===pid);
            const counts=Object.values(g.votes).filter(v=>v===pid).length;
            const voted=g.votes[currentUser.name]===pid;
            return `
              <div class="flex items-center justify-between border rounded-xl p-3 mb-2 ${voted?'border-blue-500':''}">
                <div>
                  <div class="font-medium">${p.name}</div>
                  <div class="text-xs text-gray-500">${p.province} ¬∑ ‚≠ê ${p.rating.toFixed(1)}</div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‡πÇ‡∏´‡∏ß‡∏ï: ${counts}</span>
                  <button class="px-3 py-1.5 rounded-full ${voted?'bg-blue-600 text-white':'border'}" data-vote="${pid}">${voted?'‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß':'‡πÇ‡∏´‡∏ß‡∏ï'}</button>
                </div>
              </div>
            `;
          }).join("")}
          <div class="flex items-center justify-between pt-2">
            <div class="text-sm text-gray-500">‡∏Å‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Trip Plan (One-click)</div>
            <button id="confirmTripBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-3 py-1.5">üó∫Ô∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ</button>
          </div>
        </div>
        <div id="tripSummary"></div>
      `;
      area.querySelectorAll("[data-vote]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          g.votes[currentUser.name]=btn.getAttribute("data-vote");
          document.querySelector("#groupContainer").dataset.gdata=JSON.stringify(g);
          drawGroup(g);
        });
      });
      $("#confirmTripBtn").onclick=()=>{
        const counts={}; g.proposals.forEach(pid=>counts[pid]=0);
        Object.values(g.votes).forEach(pid=>counts[pid]=(counts[pid]||0)+1);
        const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,2).map(([pid])=>pid);
        g.confirmedPlaceIds=top;
        document.querySelector("#groupContainer").dataset.gdata=JSON.stringify(g);
        drawTripSummary(top);
        alert("‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß");
      };
    }

    function drawTripSummary(ids){
      const cont=$("#tripSummary");
      const map=latestByPlace();
      cont.innerHTML=`
        <div class="bg-white border rounded-2xl p-4 mt-3">
          <div class="font-semibold mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ (One-click Plan)</div>
          ${ids.map(pid=>{
            const p=places.find(x=>x.id===pid);
            const r=map[pid];
            return `
              <div class="border rounded-2xl p-3 mb-2">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium">${p.name}</div>
                    <div class="text-xs text-gray-500">${p.province} ¬∑ ${p.category}</div>
                  </div>
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${p.rating.toFixed(1)}</span>
                </div>
                ${r?`<div class="text-sm text-gray-600 mt-1">‚Äú${clip(r.text,120)}‚Äù ‚Äî ${r.user}</div>`:""}
                <div class="mt-2"><button class="border rounded-full px-3 py-1.5 text-sm" data-act="detail" data-id="${p.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></div>
              </div>
            `;
          }).join("")}
          <div class="flex items-center justify-end">
            <button class="border rounded-full px-3 py-1.5" onclick="navigator.clipboard.writeText('Trip Plan ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ä‡∏£‡πå')">‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏ú‡∏ô</button>
          </div>
        </div>
      `;
    }

    function renderRewards(){
      $("#pointsEl").textContent=user.points+" pts";
      $("#badgesEl").textContent="‡πÅ‡∏ö‡∏î‡∏à‡πå: "+(user.badges.join(", ")||"-");
      $("#rewardsList").innerHTML=rewardsCatalog.map(rw=>`
        <div class="bg-white border rounded-2xl p-4 flex items-center justify-between">
          <div>
            <div class="font-semibold">${rw.name}</div>
            <div class="text-sm text-gray-500">${rw.desc}</div>
          </div>
          <div class="flex items-center gap-3">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">${rw.cost} pts</span>
            <button class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-3 py-1.5" data-redeem="${rw.id}">‡πÅ‡∏•‡∏Å</button>
          </div>
        </div>
      `).join("");
      $("#rewardsList").querySelectorAll("[data-redeem]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const rw=rewardsCatalog.find(r=>r.id===btn.getAttribute("data-redeem"));
          if(user.points<rw.cost){alert("‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÅ‡∏•‡∏Å");return;}
          user.points-=rw.cost; renderRewards(); renderProfileHeader();
          alert(`‡πÅ‡∏•‡∏Å "${rw.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (mock)`);
        });
      });
    }

    function renderProfileHeader(){
      $("#userNameEl").textContent=user.name;
      $("#userHandleEl").textContent=user.handle;
      $("#userMetaEl").textContent=`‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${user.level} ¬∑ ‡πÅ‡∏ï‡πâ‡∏°: ${user.points} ¬∑ ‡πÅ‡∏ö‡∏î‡∏à‡πå: ${user.badges.join(", ")||"-"}`;
      const my=reviews.filter(r=>r.user===user.name);
      $("#myReviews").innerHTML=my.length?my.map(r=>{
        const p=places.find(x=>x.id===r.placeId);
        return `
          <div class="bg-white border rounded-2xl p-3">
            <div class="flex items-center justify-between">
              <div class="font-medium">${p.name}</div>
              <div class="text-amber-600">‚≠ê ${r.rating}</div>
            </div>
            <p class="text-sm mt-1">${r.text}</p>
            ${r.verifiedVisit?`<div class="mt-2"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‚úîÔ∏é Verified Visitor</span></div>`:""}
          </div>
        `;
      }).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>`;
    }

    function renderDetail(place){
      const placeReviews=reviews.filter(r=>r.placeId===place.id).sort((a,b)=>a.date<b.date?1:-1);
      const autoNearby=places.filter(p=>p.id!==place.id).map(p=>({p,d:kmDist(place.lat,place.lng,p.lat,p.lng)}))
        .filter(({d})=>d<=10).sort((a,b)=>a.d-b.d).map(({p})=>p);
      $("#detailContent").innerHTML=`
        <header class="space-y-1">
          <div class="text-xl font-semibold">${place.name}</div>
          <div class="text-sm text-gray-500">${place.province} ¬∑ ${place.category}</div>
          <div class="flex items-center gap-2 mt-1">
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${place.rating.toFixed(1)}</span>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">Crowd: ${place.crowd}</span>
            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ${place.openingHours}</span>
          </div>
        </header>

        <section>
          <div class="font-semibold mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="space-y-2">
            ${placeReviews.length?placeReviews.map(r=>`
              <div class="border rounded-xl p-3">
                <div class="flex items-center justify-between">
                  <div class="font-medium">${r.user} <span class="text-xs text-gray-500">¬∑ ${r.userLevel||""}</span></div>
                  <div class="text-amber-600">‚≠ê ${r.rating}</div>
                </div>
                <p class="text-sm mt-1">${r.text}</p>
                ${r.verifiedVisit?`<div class="mt-2"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‚úîÔ∏é Verified Visitor</span></div>`:""}
              </div>
            `).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>`}
          </div>
        </section>

        <section>
          <div class="font-semibold mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‚â§10 ‡∏Å‡∏°.)</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            ${autoNearby.length?autoNearby.map(np=>`
              <div class="border rounded-xl p-3 flex items-center justify-between">
                <div>
                  <div class="font-medium">${np.name}</div>
                  <div class="text-xs text-gray-500">${np.category} ¬∑ ‚≠ê ${np.rating.toFixed(1)}</div>
                </div>
                <button class="px-3 py-1.5 rounded-full border" data-act="detail" data-id="${np.id}">‡∏î‡∏π</button>
              </div>
            `).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ô‡∏µ‡πâ</p>`}
          </div>
        </section>

        <div class="flex items-center justify-end gap-2">
          <button class="px-3 py-1.5 rounded-full border" onclick="navigator.clipboard.writeText('Trip: ${place.name}')">‡πÅ‡∏ä‡∏£‡πå</button>
        </div>
      `;
    }

    function openDetail(place){ renderDetail(place); setHidden($("#detailModal"), false); }
    function closeDetail(){ setHidden($("#detailModal"), true); }

    function openCreate(){ populateCreatePlaces(); updateVerifyHint(); setHidden($("#createModal"), false); }
    function closeCreate(){ setHidden($("#createModal"), true); }

    function populateCreatePlaces(){ $("#createPlace").innerHTML=places.map(p=>`<option value="${p.id}">${p.name} ¬∑ ${p.province}</option>`).join(""); }
    function updateVerifyHint(){
      const pid=$("#createPlace").value||places[0].id;
      const p=places.find(x=>x.id===pid);
      const verified=userLoc?kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)<=1:false;
      $("#verifyHint").innerHTML=verified?
        `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‚úîÔ∏é Verified Visitor (GPS)</span>`:
        `* ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Verified`;
    }

    /* ---------- Events ---------- */
    $$(".grid [data-tab]").forEach(btn=>{
      btn.onclick=()=>{
        TAB=btn.dataset.tab; renderNav();
        if(TAB==="discover"){renderDiscover()}
        if(TAB==="search"){renderSearchResults()}
        if(TAB==="groups"){renderGroups()}
        if(TAB==="rewards"){renderRewards()}
        if(TAB==="profile"){renderProfileHeader()}
      };
    });

    $("#modePostsBtn").onclick=()=>{ MODE="posts";
      $("#modePostsBtn").className="bg-blue-600 text-white rounded-full px-3 py-1.5 text-sm";
      $("#modeTilesBtn").className="border rounded-full px-3 py-1.5 text-sm";
      renderDiscover();
    };
    $("#modeTilesBtn").onclick=()=>{ MODE="tiles";
      $("#modeTilesBtn").className="bg-blue-600 text-white rounded-full px-3 py-1.5 text-sm";
      $("#modePostsBtn").className="border rounded-full px-3 py-1.5 text-sm";
      renderDiscover();
    };

    document.body.addEventListener("click",(e)=>{
      const t=e.target.closest("[data-act]");
      if(!t) return;
      const act=t.getAttribute("data-act");
      if(act==="detail"){
        const id=t.getAttribute("data-id");
        const p=places.find(x=>x.id===id);
        openDetail(p);
      } else if(act==="share"){
        const text=t.getAttribute("data-text")||"TripMate";
        if(navigator.share){ navigator.share({title:"TripMate", text}); }
        else { navigator.clipboard.writeText(text); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß"); }
      }
    });

    $("#closeDetail").onclick=closeDetail;

    $("#applySearchBtn").onclick=()=>{ QUERY=$("#searchInput").value||""; renderSearchResults(); };
    $("#searchInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ QUERY=$("#searchInput").value||""; renderSearchResults(); }});
    $("#topSearch").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ TAB="search"; renderNav(); $("#searchInput").value=e.target.value; QUERY=e.target.value; renderSearchResults(); }});

    $("#distSlider").addEventListener("input",(e)=>{ MAX_KM=Number(e.target.value); $("#distVal").textContent=MAX_KM; renderSearchResults(); });
    $("#categoryChips").addEventListener("click",(e)=>{ const b=e.target.closest("[data-cat]"); if(!b) return; CAT=b.getAttribute("data-cat"); renderSearchChips(); renderSearchResults(); });
    $("#provinceChips").addEventListener("click",(e)=>{ const b=e.target.closest("[data-prov]"); if(!b) return; PROV=b.getAttribute("data-prov"); renderSearchChips(); renderSearchResults(); });

    $("#openCreatePost").onclick=openCreate;
    $("#fabCreate").onclick=openCreate;
    $("#closeCreate").onclick=closeCreate;
    $("#cancelCreate").onclick=closeCreate;
    $("#createPlace").addEventListener("change", updateVerifyHint);
    $("#createRate").addEventListener("input",(e)=>$("#createRateLabel").textContent=e.target.value);
    $("#submitCreate").onclick=()=>{
      const placeId=$("#createPlace").value;
      const rating=Number($("#createRate").value);
      const text=$("#createText").value||"‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞";
      const p=places.find(x=>x.id===placeId);
      const verified=userLoc?kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)<=1:false;
      const newReview={id:"r_"+Date.now(), placeId, user:user.name, userLevel:user.level, rating, text, verifiedVisit:verified, date:new Date().toISOString().slice(0,10), likes:0};
      reviews=[newReview,...reviews];
      user.points+=10+(verified?5:0);
      if(verified && !user.badges.includes("Verified Explorer")) user.badges.push("Verified Explorer");
      alert(`‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏° ${10+(verified?5:0)}`);
      renderDiscover(); renderRewards(); renderProfileHeader(); closeCreate();
    };

    function init(){
      renderNav(); renderStories(); renderBanners(); renderTopTags();
      renderDiscover(); renderSearchChips(); renderSearchResults(); renderGroups(); renderRewards(); renderProfileHeader();
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition((pos)=>{
          userLoc={lat:pos.coords.latitude,lng:pos.coords.longitude};
          $("#locInfo").textContent="‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì";
          renderDiscover(); renderSearchResults(); updateVerifyHint();
        }, ()=>{
          $("#locInfo").textContent="‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏ó‡∏ô";
        }, {enableHighAccuracy:true, timeout:7000});
      } else { $("#locInfo").textContent="‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; }
    }
    init();
  </script>
</body>
</html>
